{% extends "../base.html" %} {% block title %}レビュー投稿 - {{
company.get('name') or company.get('company_name') or '企業' }}{% end %} {%
block head %}
<style>
    .review-form-container {
        max-width: 90%;
        margin: 0 auto;
        padding: 20px;
    }

    .company-info-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .company-name {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 12px;
    }

    .company-location {
        color: #6c757d;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .location-icon {
        color: #007bff;
    }

    /* フォーム表示レイアウトの改善 */
    .review-form {
        margin-top: 20px;
    }

    .form-section {
        margin-bottom: 32px;
        padding: 20px;
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
    }

    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #f8f9fa;
    }

    .employment-status-section {
        background: #f8f9fa;
    }

    .review-categories .form-section {
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }

    .form-control {
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 10px 12px;
    }

    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .review-actions {
        margin-top: 32px;
        padding-top: 24px;
        border-top: 2px solid #e9ecef;
    }

    .btn {
        border-radius: 6px;
        padding: 12px 24px;
        font-weight: 500;
    }

    /* 勤務期間入力機能のスタイル */
    .employment-period-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .employment-period-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 16px;
    }

    .period-inputs {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .period-select {
        min-width: 120px;
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        background-color: white;
    }

    .period-separator {
        font-weight: 500;
        color: #6c757d;
        margin: 0 4px;
    }

    @media (max-width: 576px) {
        .period-inputs {
            flex-direction: column;
            align-items: stretch;
        }

        .period-separator {
            text-align: center;
            margin: 8px 0;
        }

        .period-select {
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        .review-form-container {
            max-width: 100%;
            padding: 15px;
        }

        .company-info-section {
            padding: 20px;
            margin-bottom: 24px;
        }

        .company-name {
            font-size: 1.3rem;
        }
    }
</style>
{% end %} {% block content %}
<div class="review-form-container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">レビュー投稿</h2>
                </div>
                <div class="card-body">
                    <!-- 企業情報（改善版） -->
                    <div class="company-info-section">
                        <h4 class="company-name">{{ company.get('name') or company.get('company_name') or '企業名未設定' }}</h4>
                        <p class="company-location">
                            <span class="location-icon">📍</span>
                            {% if company.get('location') %}
                                {{ company['location'].split(',')[0].strip() }}
                            {% else %}
                                所在地未設定
                            {% end %}
                        </p>
                    </div>

                    <!-- 未認証時のMini Panel表示 -->
                    {% if show_login_panel %}
                    <div class="alert alert-warning" role="alert">
                        <h5 class="alert-heading">ログインが必要です</h5>
                        <p>
                            レビューを投稿するには、ログインまたはユーザー登録が必要です。
                        </p>
                        <hr />
                        <div class="d-flex gap-2">
                            <a
                                href="/login?redirect={{ handler.request.uri }}"
                                class="btn btn-primary"
                                >ログイン</a
                            >
                            <a
                                href="/auth/email/register?redirect={{ handler.request.uri }}"
                                class="btn btn-outline-primary"
                                >新規登録</a
                            >
                        </div>
                    </div>
                    {% end %}

                    <!-- レビューフォーム -->
                    {% if not show_login_panel %}
                    <form method="post" id="reviewForm">
                        {% module xsrf_form_html() %}

                        <!-- Task 3.2: 言語選択ドロップダウン -->
                        <div class="mb-4">
                            <label class="form-label fw-bold" data-i18n-label="review_language">
                                レビュー言語
                            </label>
                            <select
                                class="form-select"
                                id="reviewLanguage"
                                name="review_language"
                            >
                                {% for lang in supported_languages %}
                                <option value="{{ lang['code'] }}" {% if lang['code'] == default_language %}selected{% end %}>
                                    {{ lang['native_name'] }}
                                </option>
                                {% end %}
                            </select>
                            <small class="form-text text-muted" data-i18n-label="select_language">
                                レビューを投稿する言語を選択してください
                            </small>
                        </div>

                        <!-- 在職状況 -->
                        <div class="mb-4">
                            <label class="form-label fw-bold" data-i18n-label="employment_status"
                                >在職状況
                                <span class="text-danger" data-i18n-label="required">*</span></label
                            >
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input
                                            class="form-check-input"
                                            type="radio"
                                            name="employment_status"
                                            id="current"
                                            value="current"
                                            required
                                        />
                                        <label
                                            class="form-check-label"
                                            for="current"
                                            data-i18n-label="current_employee"
                                        >
                                            現従業員
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input
                                            class="form-check-input"
                                            type="radio"
                                            name="employment_status"
                                            id="former"
                                            value="former"
                                            required
                                        />
                                        <label
                                            class="form-check-label"
                                            for="former"
                                            data-i18n-label="former_employee"
                                        >
                                            元従業員
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 勤務期間入力 -->
                        <div class="employment-period-section">
                            <div class="employment-period-title" data-i18n-label="employment_period">勤務期間</div>
                            <!-- Task 4.3: バリデーションエラー表示エリア -->
                            <div id="employmentPeriodErrors" style="display: none;"></div>
                            <div class="period-inputs">
                                <select
                                    name="employment_start_year"
                                    id="employmentStartYear"
                                    class="period-select"
                                    data-i18n-placeholder="select_start_year"
                                >
                                    <option value="" data-i18n-placeholder="select_start_year">開始年を選択</option>
                                    <!-- JavaScriptで動的生成 -->
                                </select>
                                <span class="period-separator">〜</span>
                                <select
                                    name="employment_end_year"
                                    id="employmentEndYear"
                                    class="period-select"
                                    data-i18n-placeholder="select_end_year"
                                >
                                    <option value="" data-i18n-placeholder="select_end_year">終了年を選択</option>
                                    <option value="present" data-i18n-label="present">現在勤務</option>
                                    <!-- JavaScriptで動的生成 -->
                                </select>
                            </div>
                        </div>

                        <!-- 評価項目 -->
                        {% for category in categories %}
                        <div class="mb-4 border rounded p-3">
                            <h5 class="mb-3">
                                {{ category['index'] }}. {{ category['title'] }}
                            </h5>
                            <p class="text-muted mb-3">
                                {{ category['question'] }}
                            </p>

                            <!-- 評価選択 -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">評価</label>
                                <div class="row">
                                    {% for score in range(1, 6) %}
                                    <div class="col-2">
                                        <div class="form-check">
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="ratings[{{ category['key'] }}]"
                                                id="{{ category['key'] }}_{{ score }}"
                                                value="{{ score }}"
                                            />
                                            <label
                                                class="form-check-label"
                                                for="{{ category['key'] }}_{{ score }}"
                                            >
                                                {{ score }}点
                                            </label>
                                        </div>
                                    </div>
                                    {% end %}
                                    <div class="col-2">
                                        <div class="form-check">
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="ratings[{{ category['key'] }}]"
                                                id="{{ category['key'] }}_no_answer"
                                                value="no_answer"
                                            />
                                            <label
                                                class="form-check-label"
                                                for="{{ category['key'] }}_no_answer"
                                            >
                                                回答しない
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- コメント入力 -->
                            <div class="mb-2">
                                <label
                                    for="comment_{{ category['key'] }}"
                                    class="form-label fw-bold"
                                >
                                    コメント（任意）
                                </label>
                                <textarea
                                    class="form-control"
                                    id="comment_{{ category['key'] }}"
                                    name="comments[{{ category['key'] }}]"
                                    rows="3"
                                    maxlength="1000"
                                    placeholder="具体的な経験やエピソードがあれば教えてください（最大1000文字）"
                                ></textarea>
                                <div class="form-text">
                                    <span id="count_{{ category['key'] }}"
                                        >0</span
                                    >/1000文字
                                </div>
                            </div>
                        </div>
                        {% end %}

                        <!-- プレビュー表示 -->
                        <div class="mb-4">
                            <h5>レビュー点数プレビュー</h5>
                            <div class="bg-light p-3 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <span class="fw-bold"
                                            >あなたのレビュー点数:
                                        </span>
                                        <span
                                            id="previewRating"
                                            class="h4 text-warning"
                                            >-.-</span
                                        >
                                        <small class="text-muted"
                                            >（<span id="answeredCount">0</span
                                            >項目回答）</small
                                        >
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <small class="text-muted"
                                            >回答した項目の平均点</small
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Task 6.3: プレビューボタン -->
                        <input type="hidden" name="mode" id="formMode" value="preview" />
                        <div class="d-flex justify-content-between">
                            <a
                                href="/companies/{{ company['id'] }}"
                                class="btn btn-secondary"
                                >キャンセル</a
                            >
                            <button
                                type="submit"
                                class="btn btn-primary btn-lg"
                                id="submitBtn"
                                disabled
                            >
                                プレビュー →
                            </button>
                        </div>
                    </form>
                    {% end %}
                </div>
            </div>

            <!-- 注意事項 -->
            {% if not show_login_panel %}
            <div class="mt-4">
                <div class="alert alert-info">
                    <h6>
                        <i class="bi bi-info-circle"></i> 投稿に関する注意事項
                    </h6>
                    <ul class="mb-0">
                        <li>同じ会社への投稿は1年間に1回までです</li>
                        <li>投稿から1年以内であれば、内容を編集できます</li>
                        <li>すべての項目への回答は必須ではありません</li>
                        <li>具体的で建設的なコメントをお願いします</li>
                    </ul>
                </div>
            </div>
            {% end %}
        </div>
    </div>
</div>

{% if not show_login_panel %}
<!-- Task 3.3, 4.1, 4.3: reviewForm.js の読み込み -->
<script src="/static/js/reviewForm.js"></script>
<script>
    // Task 3.2: 翻訳辞書をJavaScriptで利用可能にする
    const translations = {{ translations }};

    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("reviewForm");
        const submitBtn = document.getElementById("submitBtn");
        const previewRating = document.getElementById("previewRating");
        const answeredCount = document.getElementById("answeredCount");

        // Task 3.3: ReviewFormインスタンス作成
        const reviewForm = new ReviewForm(translations);

        // Task 3.3: ブラウザ言語からデフォルト言語を設定
        const defaultLang = reviewForm.detectBrowserLanguage();
        const languageSelect = document.getElementById('reviewLanguage');
        if (languageSelect && !languageSelect.value) {
            languageSelect.value = defaultLang;
        }
        reviewForm.switchLanguage(languageSelect ? languageSelect.value : defaultLang);

        // Task 3.3: 言語選択の変更イベント
        if (languageSelect) {
            languageSelect.addEventListener('change', function() {
                reviewForm.switchLanguage(this.value);
            });
        }

        // 勤務期間ドロップダウンの初期化
        initializeEmploymentPeriodDropdowns();

        // 文字カウント機能
        document
            .querySelectorAll('textarea[name^="comments"]')
            .forEach((textarea) => {
                const category = textarea.name.match(/comments\[(\w+)\]/)[1];
                const counter = document.getElementById(`count_${category}`);

                textarea.addEventListener("input", function () {
                    counter.textContent = this.value.length;
                });
            });

        // リアルタイムプレビュー計算
        function updatePreview() {
            const ratings = [];
            let hasEmploymentStatus = false;

            // 在職状況チェック
            const employmentStatus = form.querySelector(
                'input[name="employment_status"]:checked',
            );
            hasEmploymentStatus = !!employmentStatus;

            // 評価点数を収集
            document
                .querySelectorAll('input[name^="ratings"]:checked')
                .forEach((radio) => {
                    if (radio.value !== "no_answer") {
                        ratings.push(parseInt(radio.value));
                    }
                });

            // 平均点計算
            if (ratings.length > 0) {
                const average =
                    ratings.reduce((sum, rating) => sum + rating, 0) /
                    ratings.length;
                previewRating.textContent = average.toFixed(1);
                answeredCount.textContent = ratings.length;
            } else {
                previewRating.textContent = "-.-";
                answeredCount.textContent = "0";
            }

            // 投稿ボタンの有効/無効制御
            submitBtn.disabled = !hasEmploymentStatus || ratings.length === 0;
        }

        // イベントリスナー設定
        form.addEventListener("change", updatePreview);

        // 初期プレビュー更新
        updatePreview();

        // 勤務期間ドロップダウンの初期化関数
        function initializeEmploymentPeriodDropdowns() {
            const currentYear = new Date().getFullYear();
            const startYear = 1970;

            const startYearSelect = document.getElementById(
                "employmentStartYear",
            );
            const endYearSelect = document.getElementById("employmentEndYear");

            // 開始年ドロップダウンを生成（1970年から現在年まで）
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = year + "年";
                startYearSelect.appendChild(option);
            }

            // 終了年ドロップダウンを生成（1970年から現在年まで）
            // 「現在勤務」オプションは既にHTMLに存在
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = year + "年";
                endYearSelect.appendChild(option);
            }

            // 開始年変更時の終了年制限ロジック
            startYearSelect.addEventListener("change", function () {
                const selectedStartYear = parseInt(this.value);
                if (selectedStartYear) {
                    updateEndYearOptions(selectedStartYear, endYearSelect);
                }
            });
        }

        function updateEndYearOptions(startYear, endYearSelect) {
            const currentYear = new Date().getFullYear();

            // 既存のオプション（「現在勤務」以外）をクリア
            const currentOption = endYearSelect.querySelector(
                'option[value="current"]',
            );
            const emptyOption = endYearSelect.querySelector('option[value=""]');

            endYearSelect.innerHTML = "";
            if (emptyOption) endYearSelect.appendChild(emptyOption);
            if (currentOption) endYearSelect.appendChild(currentOption);

            // 開始年以降の年数のみを追加
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = year + "年";
                endYearSelect.appendChild(option);
            }
        }

        // Task 4.1: 雇用状態選択時の自動入力サポート
        const currentRadio = document.getElementById('current');
        const formerRadio = document.getElementById('former');
        const endYearSelect = document.getElementById('employmentEndYear');

        if (currentRadio && formerRadio && endYearSelect) {
            currentRadio.addEventListener('change', function() {
                if (this.checked) {
                    reviewForm.handleEmploymentStatusChange('current', endYearSelect);
                }
            });

            formerRadio.addEventListener('change', function() {
                if (this.checked) {
                    reviewForm.handleEmploymentStatusChange('former', endYearSelect);
                }
            });
        }

        // Task 4.3: フォーム送信前のバリデーション
        const errorContainer = document.getElementById('employmentPeriodErrors');

        form.addEventListener("submit", function (e) {
            const employmentStatus = form.querySelector(
                'input[name="employment_status"]:checked',
            );
            const hasAnyRating =
                form.querySelectorAll('input[name^="ratings"]:checked').length >
                0;

            if (!employmentStatus) {
                alert("在職状況を選択してください");
                e.preventDefault();
                return;
            }

            if (!hasAnyRating) {
                alert("少なくとも1つの項目に評価をつけてください");
                e.preventDefault();
                return;
            }

            // Task 4.3: 雇用期間バリデーション
            if (!reviewForm.validateOnSubmit(form, errorContainer)) {
                e.preventDefault();
                return;
            }
        });
    });
</script>
{% end %} {% end %}
