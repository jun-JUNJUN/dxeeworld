{% extends "../base.html" %}

{% block title %}ä¼æ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§{% end %}

{% block head %}
<style>
    /* Task 9.2: ãƒ¬ãƒ“ãƒ¥ãƒ¼è©•ä¾¡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .rating-slider-container {
        padding: 10px 0;
    }

    .rating-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #dc3545 0%, #ffc107 50%, #28a745 100%);
        outline: none;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .rating-slider:hover {
        opacity: 1;
    }

    .rating-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .rating-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        border: none;
    }

    .rating-value-display {
        font-size: 1.1rem;
        font-weight: 600;
        color: #007bff;
        text-align: center;
        margin-top: 5px;
    }

    .filter-section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control:disabled,
    .form-select:disabled {
        background-color: #e9ecef;
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% end %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">ä¼æ¥­ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œç´¢</h1>

            <!-- Task 9.1: ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
            {% if access_level == 'denied' %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™</h4>
                <p>{{ access_message if access_message else "ã“ã®ãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚" }}</p>
                <hr>
                <p class="mb-0">ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ã‚’é–²è¦§ã™ã‚‹ã«ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            {% else %}

            <!-- Task 9.1: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹é€šçŸ¥ -->
            {% if access_level == 'preview' %}
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">â„¹ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰</h4>
                <p>ç¾åœ¨ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§é–²è¦§ã—ã¦ã„ã¾ã™ã€‚å®Œå…¨ãªãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’è¦‹ã‚‹ã«ã¯ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            {% end %}

            <!-- Task 9.1: Webã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹é€šçŸ¥ -->
            {% if access_level == 'crawler' %}
            <div class="alert alert-secondary" role="alert">
                <h4 class="alert-heading">ğŸ¤– æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³å‘ã‘è¡¨ç¤º</h4>
                <p>æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³æœ€é©åŒ–ã®ãŸã‚ã®æœ€å°é™ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
            </div>
            {% end %}

            <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" action="/review">
                        <!-- Task 9.1: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç„¡åŠ¹åŒ–é€šçŸ¥ -->
                        {% if not can_filter %}
                        <div class="alert alert-warning mb-3" role="alert">
                            <strong>ğŸ”’ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚</strong>
                            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã™ã‚‹ã¨ã€è©³ç´°ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                        </div>
                        {% end %}

                        <!-- Task 9.2: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIæ”¹å–„ -->
                        <div class="row">
                            <!-- Task 9.2: ä¼æ¥­åãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                            <div class="col-md-4 mb-3">
                                <label for="name" class="form-label filter-section-title">ğŸ¢ ä¼æ¥­å</label>
                                <input type="text" class="form-control" id="name" name="name"
                                       value="{{ search_params.get('name', '') }}" placeholder="ä¼æ¥­åã§æ¤œç´¢"
                                       {% if not can_filter %}disabled{% end %}>
                            </div>

                            <!-- Task 9.2: åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                            <div class="col-md-4 mb-3">
                                <label for="location" class="form-label filter-section-title">ğŸ“ æ‰€åœ¨åœ°</label>
                                <input type="text" class="form-control" id="location" name="location"
                                       value="{{ search_params.get('location', '') }}" placeholder="æ±äº¬éƒ½ã€å¤§é˜ªåºœãªã©"
                                       {% if not can_filter %}disabled{% end %}>
                            </div>

                            <!-- Task 9.2: ä¸¦ã³é † -->
                            <div class="col-md-4 mb-3">
                                <label for="sort" class="form-label filter-section-title">ğŸ”½ ä¸¦ã³é †</label>
                                <select class="form-select" id="sort" name="sort">
                                    <option value="rating_high"
                                        {% if search_params.get('sort') == 'rating_high' %}selected{% end %}>
                                        è©•ä¾¡é †ï¼ˆé«˜â†’ä½ï¼‰
                                    </option>
                                    <option value="rating_low"
                                        {% if search_params.get('sort') == 'rating_low' %}selected{% end %}>
                                        è©•ä¾¡é †ï¼ˆä½â†’é«˜ï¼‰
                                    </option>
                                    <option value="review_count"
                                        {% if search_params.get('sort') == 'review_count' %}selected{% end %}>
                                        ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°é †
                                    </option>
                                    <option value="name"
                                        {% if search_params.get('sort') == 'name' %}selected{% end %}>
                                        ä¼æ¥­åé †
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Task 9.2: ãƒ¬ãƒ“ãƒ¥ãƒ¼è©•ä¾¡ç¯„å›²ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="min_rating_slider" class="form-label filter-section-title">â­ æœ€ä½è©•ä¾¡</label>
                                <div class="rating-slider-container">
                                    <input type="range" class="rating-slider" id="min_rating_slider"
                                           min="0" max="5" step="0.5"
                                           value="{{ search_params.get('min_rating', 0) }}"
                                           {% if not can_filter %}disabled{% end %}
                                           oninput="updateMinRatingDisplay(this.value)">
                                    <input type="hidden" id="min_rating" name="min_rating" value="{{ search_params.get('min_rating', '') }}">
                                    <div class="rating-value-display" id="min_rating_display">
                                        {% if search_params.get('min_rating') %}
                                            {{ search_params.get('min_rating') }} ä»¥ä¸Š
                                        {% else %}
                                            æŒ‡å®šãªã—
                                        {% end %}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="max_rating_slider" class="form-label filter-section-title">â­ æœ€é«˜è©•ä¾¡</label>
                                <div class="rating-slider-container">
                                    <input type="range" class="rating-slider" id="max_rating_slider"
                                           min="0" max="5" step="0.5"
                                           value="{{ search_params.get('max_rating', 5) }}"
                                           {% if not can_filter %}disabled{% end %}
                                           oninput="updateMaxRatingDisplay(this.value)">
                                    <input type="hidden" id="max_rating" name="max_rating" value="{{ search_params.get('max_rating', '') }}">
                                    <div class="rating-value-display" id="max_rating_display">
                                        {% if search_params.get('max_rating') %}
                                            {{ search_params.get('max_rating') }} ä»¥ä¸‹
                                        {% else %}
                                            æŒ‡å®šãªã—
                                        {% end %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Task 9.2: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ãƒœã‚¿ãƒ³ -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" {% if not can_filter %}disabled{% end %}>
                                ğŸ” æ¤œç´¢
                            </button>
                            <a href="/review" class="btn btn-secondary" {% if not can_filter %}disabled{% end %}>
                                ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            {% end %}

            <!-- æ¤œç´¢çµæœ -->
            <div class="search-results">
                {% if companies %}
                    <p class="text-muted">{{ pagination['total'] }}ä»¶ã®ä¼æ¥­ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</p>

                    <div class="row">
                        {% for company in companies %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title">
                                            <a href="/companies/{{ company.get('id', company.get('_id', '')) }}" class="text-decoration-none">
                                                {{ company.get('name', '') }}
                                            </a>
                                        </h5>
                                        <div class="text-end">
                                            <div class="h4 text-warning mb-0">
                                                â˜…{{ "%.1f"|format(company.get('overall_average', 0)) }}
                                            </div>
                                            <small class="text-muted">{{ company.get('total_reviews', 0) }}ä»¶ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼</small>
                                        </div>
                                    </div>

                                    <p class="text-muted mb-2">
                                        <i class="bi bi-geo-alt"></i> {{ company.get('location', '') }}
                                    </p>

                                    <!-- é …ç›®åˆ¥è©•ä¾¡ -->
                                    {% if company.get('category_averages') %}
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">æ¨è–¦åº¦</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('recommendation', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">å—å…¥åˆ¶åº¦</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('foreign_support', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">ä¼šç¤¾é¢¨åœŸ</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('company_culture', 0)) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-2">
                                        <div class="col-4">
                                            <small class="text-muted">é–¢ä¿‚æ€§</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('employee_relations', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">è©•ä¾¡åˆ¶åº¦</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('evaluation_system', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">æ˜‡é€²å¾…é‡</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('promotion_treatment', 0)) }}
                                            </span>
                                        </div>
                                    </div>
                                    {% end %}
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex justify-content-between">
                                        <a href="/companies/{{ company.get('id', company.get('_id', '')) }}" class="btn btn-sm btn-outline-primary">
                                            è©³ç´°ã‚’è¦‹ã‚‹
                                        </a>
                                        <a href="/companies/{{ company.get('id', company.get('_id', '')) }}/reviews/new" class="btn btn-sm btn-primary">
                                            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% end %}
                    </div>

                    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                    {% if pagination['pages'] > 1 %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if pagination['page'] > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ pagination['page'] - 1 }}&{{ '&'.join(['%s=%s' % (k,v) for k,v in search_params.items() if k != 'page' and v]) }}">
                                    å‰ã¸
                                </a>
                            </li>
                            {% end %}

                            {% for page_num in range(max(1, pagination['page'] - 2), min(pagination['pages'] + 1, pagination['page'] + 3)) %}
                            <li class="page-item {% if page_num == pagination['page'] %}active{% end %}">
                                <a class="page-link" href="?page={{ page_num }}&{{ '&'.join(['%s=%s' % (k,v) for k,v in search_params.items() if k != 'page' and v]) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% end %}

                            {% if pagination['page'] < pagination['pages'] %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ pagination['page'] + 1 }}&{{ '&'.join(['%s=%s' % (k,v) for k,v in search_params.items() if k != 'page' and v]) }}">
                                    æ¬¡ã¸
                                </a>
                            </li>
                            {% end %}
                        </ul>
                    </nav>
                    {% end %}

                {% else %}
                    <div class="text-center py-5">
                        <h4 class="text-muted">è©²å½“ã™ã‚‹ä¼æ¥­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h4>
                        <p class="text-muted">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„</p>
                    </div>
                {% end %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Task 9.2: ãƒ¬ãƒ“ãƒ¥ãƒ¼è©•ä¾¡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®JavaScript
    function updateMinRatingDisplay(value) {
        const display = document.getElementById('min_rating_display');
        const hiddenInput = document.getElementById('min_rating');

        if (parseFloat(value) === 0) {
            display.textContent = 'æŒ‡å®šãªã—';
            hiddenInput.value = '';
        } else {
            display.textContent = value + ' ä»¥ä¸Š';
            hiddenInput.value = value;
        }
    }

    function updateMaxRatingDisplay(value) {
        const display = document.getElementById('max_rating_display');
        const hiddenInput = document.getElementById('max_rating');

        if (parseFloat(value) === 5) {
            display.textContent = 'æŒ‡å®šãªã—';
            hiddenInput.value = '';
        } else {
            display.textContent = value + ' ä»¥ä¸‹';
            hiddenInput.value = value;
        }
    }

    // Task 9.2: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åˆæœŸå€¤ã‚’è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
        const minSlider = document.getElementById('min_rating_slider');
        const maxSlider = document.getElementById('max_rating_slider');

        if (minSlider) {
            updateMinRatingDisplay(minSlider.value);
        }

        if (maxSlider) {
            updateMaxRatingDisplay(maxSlider.value);
        }
    });
</script>
{% end %}

{% end %}