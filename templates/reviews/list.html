{% extends "../base.html" %}

{% block title %}企業レビュー一覧{% end %}

{% block head %}
<style>
    /* Task 9.2: レビュー評価スライダーのカスタムスタイル */
    .rating-slider-container {
        padding: 10px 0;
    }

    .rating-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #dc3545 0%, #ffc107 50%, #28a745 100%);
        outline: none;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .rating-slider:hover {
        opacity: 1;
    }

    .rating-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .rating-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        border: none;
    }

    .rating-value-display {
        font-size: 1.1rem;
        font-weight: 600;
        color: #007bff;
        text-align: center;
        margin-top: 5px;
    }

    .filter-section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control:disabled,
    .form-select:disabled {
        background-color: #e9ecef;
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% end %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">企業レビュー検索</h1>

            <!-- Task 9.1: アクセス拒否メッセージ表示 -->
            {% if access_level == 'denied' %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">⚠️ アクセス制限</h4>
                <p>{{ access_message if access_message else "このページへのアクセスは制限されています。" }}</p>
                <hr>
                <p class="mb-0">レビュー一覧を閲覧するには、ログインしてレビューを投稿してください。</p>
            </div>
            {% else %}

            <!-- Task 9.1: プレビューアクセス通知 -->
            {% if access_level == 'preview' %}
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">ℹ️ プレビューモード</h4>
                <p>現在、プレビューモードで閲覧しています。完全なレビュー内容を見るには、レビューを投稿してください。</p>
            </div>
            {% end %}

            <!-- Task 9.1: Webクローラーアクセス通知 -->
            {% if access_level == 'crawler' %}
            <div class="alert alert-secondary" role="alert">
                <h4 class="alert-heading">🤖 検索エンジン向け表示</h4>
                <p>検索エンジン最適化のための最小限の情報を表示しています。</p>
            </div>
            {% end %}

            <!-- 検索フォーム -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" action="/review">
                        <!-- Task 9.1: フィルター無効化通知 -->
                        {% if not can_filter %}
                        <div class="alert alert-warning mb-3" role="alert">
                            <strong>🔒 フィルター機能は制限されています。</strong>
                            レビューを投稿すると、詳細なフィルター機能が使えるようになります。
                        </div>
                        {% end %}

                        <!-- Task 9.2: フィルターUI改善 -->
                        <div class="row">
                            <!-- Task 9.2: 企業名フィルター -->
                            <div class="col-md-4 mb-3">
                                <label for="name" class="form-label filter-section-title">🏢 企業名</label>
                                <input type="text" class="form-control" id="name" name="name"
                                       value="{{ search_params.get('name', '') }}" placeholder="企業名で検索"
                                       {% if not can_filter %}disabled{% end %}>
                            </div>

                            <!-- Task 9.2: 地域フィルター -->
                            <div class="col-md-4 mb-3">
                                <label for="location" class="form-label filter-section-title">📍 所在地</label>
                                <input type="text" class="form-control" id="location" name="location"
                                       value="{{ search_params.get('location', '') }}" placeholder="東京都、大阪府など"
                                       {% if not can_filter %}disabled{% end %}>
                            </div>

                            <!-- Task 9.2: 並び順 -->
                            <div class="col-md-4 mb-3">
                                <label for="sort" class="form-label filter-section-title">🔽 並び順</label>
                                <select class="form-select" id="sort" name="sort">
                                    <option value="rating_high"
                                        {% if search_params.get('sort') == 'rating_high' %}selected{% end %}>
                                        評価順（高→低）
                                    </option>
                                    <option value="rating_low"
                                        {% if search_params.get('sort') == 'rating_low' %}selected{% end %}>
                                        評価順（低→高）
                                    </option>
                                    <option value="review_count"
                                        {% if search_params.get('sort') == 'review_count' %}selected{% end %}>
                                        レビュー数順
                                    </option>
                                    <option value="name"
                                        {% if search_params.get('sort') == 'name' %}selected{% end %}>
                                        企業名順
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Task 9.2: レビュー評価範囲スライダー -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="min_rating_slider" class="form-label filter-section-title">⭐ 最低評価</label>
                                <div class="rating-slider-container">
                                    <input type="range" class="rating-slider" id="min_rating_slider"
                                           min="0" max="5" step="0.5"
                                           value="{{ search_params.get('min_rating', 0) }}"
                                           {% if not can_filter %}disabled{% end %}
                                           oninput="updateMinRatingDisplay(this.value)">
                                    <input type="hidden" id="min_rating" name="min_rating" value="{{ search_params.get('min_rating', '') }}">
                                    <div class="rating-value-display" id="min_rating_display">
                                        {% if search_params.get('min_rating') %}
                                            {{ search_params.get('min_rating') }} 以上
                                        {% else %}
                                            指定なし
                                        {% end %}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="max_rating_slider" class="form-label filter-section-title">⭐ 最高評価</label>
                                <div class="rating-slider-container">
                                    <input type="range" class="rating-slider" id="max_rating_slider"
                                           min="0" max="5" step="0.5"
                                           value="{{ search_params.get('max_rating', 5) }}"
                                           {% if not can_filter %}disabled{% end %}
                                           oninput="updateMaxRatingDisplay(this.value)">
                                    <input type="hidden" id="max_rating" name="max_rating" value="{{ search_params.get('max_rating', '') }}">
                                    <div class="rating-value-display" id="max_rating_display">
                                        {% if search_params.get('max_rating') %}
                                            {{ search_params.get('max_rating') }} 以下
                                        {% else %}
                                            指定なし
                                        {% end %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Task 9.2: フィルター適用ボタン -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" {% if not can_filter %}disabled{% end %}>
                                🔍 検索
                            </button>
                            <a href="/review" class="btn btn-secondary" {% if not can_filter %}disabled{% end %}>
                                🔄 リセット
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            {% end %}

            <!-- 検索結果 -->
            <div class="search-results">
                {% if companies %}
                    <p class="text-muted">{{ pagination['total'] }}件の企業が見つかりました</p>

                    <div class="row">
                        {% for company in companies %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title">
                                            <a href="/companies/{{ company.get('id', company.get('_id', '')) }}" class="text-decoration-none">
                                                {{ company.get('name', '') }}
                                            </a>
                                        </h5>
                                        <div class="text-end">
                                            <div class="h4 text-warning mb-0">
                                                ★{{ "%.1f"|format(company.get('overall_average', 0)) }}
                                            </div>
                                            <small class="text-muted">{{ company.get('total_reviews', 0) }}件のレビュー</small>
                                        </div>
                                    </div>

                                    <p class="text-muted mb-2">
                                        <i class="bi bi-geo-alt"></i> {{ company.get('location', '') }}
                                    </p>

                                    <!-- 項目別評価 -->
                                    {% if company.get('category_averages') %}
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">推薦度</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('recommendation', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">受入制度</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('foreign_support', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">会社風土</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('company_culture', 0)) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-2">
                                        <div class="col-4">
                                            <small class="text-muted">関係性</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('employee_relations', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">評価制度</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('evaluation_system', 0)) }}
                                            </span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">昇進待遇</small><br>
                                            <span class="badge bg-secondary">
                                                {{ "%.1f"|format(company.get('category_averages', {}).get('promotion_treatment', 0)) }}
                                            </span>
                                        </div>
                                    </div>
                                    {% end %}
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex justify-content-between">
                                        <a href="/companies/{{ company.get('id', company.get('_id', '')) }}" class="btn btn-sm btn-outline-primary">
                                            詳細を見る
                                        </a>
                                        <a href="/companies/{{ company.get('id', company.get('_id', '')) }}/reviews/new" class="btn btn-sm btn-primary">
                                            レビューを書く
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% end %}
                    </div>

                    <!-- ページネーション -->
                    {% if pagination['pages'] > 1 %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if pagination['page'] > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ pagination['page'] - 1 }}&{{ '&'.join(['%s=%s' % (k,v) for k,v in search_params.items() if k != 'page' and v]) }}">
                                    前へ
                                </a>
                            </li>
                            {% end %}

                            {% for page_num in range(max(1, pagination['page'] - 2), min(pagination['pages'] + 1, pagination['page'] + 3)) %}
                            <li class="page-item {% if page_num == pagination['page'] %}active{% end %}">
                                <a class="page-link" href="?page={{ page_num }}&{{ '&'.join(['%s=%s' % (k,v) for k,v in search_params.items() if k != 'page' and v]) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% end %}

                            {% if pagination['page'] < pagination['pages'] %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ pagination['page'] + 1 }}&{{ '&'.join(['%s=%s' % (k,v) for k,v in search_params.items() if k != 'page' and v]) }}">
                                    次へ
                                </a>
                            </li>
                            {% end %}
                        </ul>
                    </nav>
                    {% end %}

                {% else %}
                    <div class="text-center py-5">
                        <h4 class="text-muted">該当する企業が見つかりませんでした</h4>
                        <p class="text-muted">検索条件を変更してお試しください</p>
                    </div>
                {% end %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Task 9.2: レビュー評価スライダーのJavaScript
    function updateMinRatingDisplay(value) {
        const display = document.getElementById('min_rating_display');
        const hiddenInput = document.getElementById('min_rating');

        if (parseFloat(value) === 0) {
            display.textContent = '指定なし';
            hiddenInput.value = '';
        } else {
            display.textContent = value + ' 以上';
            hiddenInput.value = value;
        }
    }

    function updateMaxRatingDisplay(value) {
        const display = document.getElementById('max_rating_display');
        const hiddenInput = document.getElementById('max_rating');

        if (parseFloat(value) === 5) {
            display.textContent = '指定なし';
            hiddenInput.value = '';
        } else {
            display.textContent = value + ' 以下';
            hiddenInput.value = value;
        }
    }

    // Task 9.2: ページロード時にスライダーの初期値を設定
    document.addEventListener('DOMContentLoaded', function() {
        const minSlider = document.getElementById('min_rating_slider');
        const maxSlider = document.getElementById('max_rating_slider');

        if (minSlider) {
            updateMinRatingDisplay(minSlider.value);
        }

        if (maxSlider) {
            updateMaxRatingDisplay(maxSlider.value);
        }
    });
</script>
{% end %}

{% end %}