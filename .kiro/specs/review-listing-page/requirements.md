# Requirements Document

## はじめに

レビュー一覧ページ（/review）は、企業のレビュー情報を集計・表示し、ユーザーが企業評価を一覧で確認できるWebページです。レビュー投稿時に非同期処理で事前集計されたデータを活用し、評価順・レビュー数順などの多様なソート機能、企業名・所在地・評価範囲による検索・フィルター機能、そしてアクセス制御と連動したフィルタリング機能を提供します。

本機能により、ユーザーは企業の評価情報を効率的に閲覧・比較し、転職やビジネス判断に必要な情報を容易に取得できるようになります。集計処理をレビュー投稿時に非同期で実行することで、ページ表示のパフォーマンスを最適化し、大量のレビューデータがある場合でも高速な閲覧体験を提供します。

## Requirements

### Requirement 1: レビュー投稿時の企業単位非同期集計処理
**Objective:** ユーザーとして、最新のレビュー情報を反映した企業評価データを閲覧したい。そのため、レビューが投稿されたタイミングで、当該企業のレビューデータを企業単位で集計する非同期処理が必要。ページ表示時には事前集計されたデータを利用することで、高速なレスポンスを実現する。

#### Acceptance Criteria

1. WHEN レビューが企業に対して投稿される THEN レビューシステム SHALL 投稿されたレビューの企業IDを特定する
2. WHEN レビュー投稿処理が完了する THEN レビューシステム SHALL 当該企業単位のレビュー集計処理を非同期タスクとしてキューに追加する
3. WHEN 非同期集計タスクが実行される THEN レビュー集計システム SHALL 対象企業（企業単位）のすべてのレビューをクエリする
4. WHEN 企業単位でレビューを集計する THEN レビュー集計システム SHALL 総合評価平均（overall_average）を全カテゴリの評価平均から計算する
5. WHEN 企業単位でレビューを集計する THEN レビュー集計システム SHALL レビュー総数（total_reviews）を当該企業に投稿されたレビュー数から計算する
6. WHEN 企業単位でレビューを集計する THEN レビュー集計システム SHALL カテゴリ別評価平均（recommendation、foreign_support、company_culture、employee_relations、evaluation_system、promotion_treatment）を計算する
7. WHEN 企業単位でレビューを集計する THEN レビュー集計システム SHALL 最終更新日時（last_review_date）を最新レビューの投稿日時から取得する
8. IF レビューのカテゴリ評価値が None である THEN レビュー集計システム SHALL そのカテゴリの評価を集計から除外する
9. WHEN カテゴリ別評価平均を計算する THEN レビュー集計システム SHALL 有効な評価値（None以外）のみを使用して平均を計算する
10. WHEN 総合評価平均を計算する THEN レビュー集計システム SHALL 全カテゴリの評価平均値の平均として計算する
11. WHEN 企業単位の集計処理が完了する THEN レビュー集計システム SHALL 計算された集計データを当該企業レコードまたは専用の集計テーブルに保存する
12. IF 集計処理中にエラーが発生した THEN レビュー集計システム SHALL エラーをログに記録し、リトライ可能な場合は再試行する

### Requirement 2: 企業一覧の表示順序とソート機能
**Objective:** ユーザーとして、目的に応じた順序で企業一覧を閲覧したい。そのため、デフォルトの最新レビュー順に加えて、評価順やレビュー数順など複数のソートオプションが必要。

#### Acceptance Criteria

1. WHEN レビュー一覧ページが初回表示される THEN レビュー一覧システム SHALL 企業を最新レビュー投稿順（last_review_date降順）で表示する
2. WHEN ユーザーが「評価順（高→低）」を選択する THEN レビュー一覧システム SHALL 企業を総合評価平均（overall_average）の降順でソートして表示する
3. WHEN ユーザーが「評価順（低→高）」を選択する THEN レビュー一覧システム SHALL 企業を総合評価平均（overall_average）の昇順でソートして表示する
4. WHEN ユーザーが「レビュー数順」を選択する THEN レビュー一覧システム SHALL 企業をレビュー総数（total_reviews）の降順でソートして表示する
5. WHEN ユーザーが「企業名順」を選択する THEN レビュー一覧システム SHALL 企業を企業名（name）の昇順でソートして表示する
6. WHEN ユーザーが「最新レビュー順」を選択する THEN レビュー一覧システム SHALL 企業を最終更新日時（last_review_date）の降順でソートして表示する

### Requirement 3: 検索とフィルタリング機能
**Objective:** ユーザーとして、特定の条件に合致する企業のみを絞り込んで閲覧したい。そのため、企業名・所在地・評価範囲による柔軟な検索・フィルター機能が必要。

#### Acceptance Criteria

1. WHEN ユーザーが企業名をフィルター入力欄に入力する THEN レビュー一覧システム SHALL 入力テキストを部分一致検索条件として企業名フィルタリングを実行する
2. WHEN ユーザーが所在地をフィルター入力欄に入力する THEN レビュー一覧システム SHALL 入力テキストを部分一致検索条件として所在地フィルタリングを実行する
3. WHEN ユーザーが最低評価スライダーを操作する THEN レビュー一覧システム SHALL 0.0〜5.0の範囲で0.5刻みの最低評価値を設定し、総合評価平均がその値以上の企業のみを表示する
4. WHEN ユーザーが最高評価スライダーを操作する THEN レビュー一覧システム SHALL 0.0〜5.0の範囲で0.5刻みの最高評価値を設定し、総合評価平均がその値以下の企業のみを表示する
5. WHEN ユーザーが複数のフィルター条件を設定する THEN レビュー一覧システム SHALL すべての条件を満たす企業のみを表示する（AND条件）

### Requirement 4: アクセス制御と連動したフィルタリング
**Objective:** 管理者として、ユーザーのアクセス権限に応じてフィルター機能の利用を制御したい。そのため、アクセス制御設定と連動したフィルター有効化・無効化機能が必要。

#### Acceptance Criteria

1. IF ユーザーのアクセス制御設定で can_filter=false である THEN レビュー一覧システム SHALL すべてのフィルター入力欄を無効化する
2. IF ユーザーのアクセス制御設定で can_filter=false である THEN レビュー一覧システム SHALL すべての企業を表示する（フィルタリング未適用）
3. IF ユーザーのアクセス制御設定で can_filter=true である THEN レビュー一覧システム SHALL すべてのフィルター機能を有効化する
4. WHEN フィルター機能が無効化されている THEN レビュー一覧システム SHALL フィルター入力欄に無効状態を示すUI表示を行う

### Requirement 5: 事前集計データの取得とページネーション
**Objective:** ユーザーとして、大量の企業データを効率的に閲覧したい。そのため、レビュー投稿時に事前集計された企業評価データを高速に取得し、ページネーション機能により適切な件数ずつ企業情報を表示する機能が必要。

#### Acceptance Criteria

1. WHEN レビュー一覧ページが表示される THEN レビュー一覧システム SHALL 事前集計済みの企業評価データを取得する
2. WHEN 企業データを取得する THEN レビュー一覧システム SHALL 企業レコードまたは専用の集計テーブルから集計済みデータ（overall_average、total_reviews、カテゴリ別評価平均、last_review_date）を読み込む
3. WHEN 企業データを取得する THEN レビュー一覧システム SHALL 集計データが存在する企業のみを表示対象とする
4. WHEN 企業データを取得する THEN レビュー一覧システム SHALL フィルター条件とソート順序とページネーション設定を適用して企業を取得する
5. WHEN レビュー一覧ページが表示される THEN レビュー一覧システム SHALL 1ページあたり20件の企業を表示する
6. WHEN 企業データが20件を超える THEN レビュー一覧システム SHALL ページ番号ナビゲーションを表示する
7. WHEN ページ番号ナビゲーションが表示される THEN レビュー一覧システム SHALL 「前へ」ボタンと「次へ」ボタンを表示する
8. IF 現在のページが1ページ目である THEN レビュー一覧システム SHALL 「前へ」ボタンを無効化する
9. IF 現在のページが最終ページである THEN レビュー一覧システム SHALL 「次へ」ボタンを無効化する
10. WHEN ユーザーがページ番号をクリックする THEN レビュー一覧システム SHALL 指定されたページの企業一覧を表示する
11. IF 企業に集計データが存在しない（レビューが投稿されていない）THEN レビュー一覧システム SHALL その企業をレビュー一覧ページに表示しない

### Requirement 6: 企業カード表示とユーザーインタラクション
**Objective:** ユーザーとして、企業の重要な情報を一目で把握し、詳細閲覧やレビュー投稿へスムーズに遷移したい。そのため、必要な情報を集約した企業カードと明確な行動ボタンが必要。

#### Acceptance Criteria

1. WHEN 各企業をカード形式で表示する THEN レビュー一覧システム SHALL 企業名を表示する
2. WHEN 各企業をカード形式で表示する THEN レビュー一覧システム SHALL 所在地を表示する
3. WHEN 各企業をカード形式で表示する THEN レビュー一覧システム SHALL 総合評価を星マーク（★）と数値形式で表示する
4. WHEN 各企業をカード形式で表示する THEN レビュー一覧システム SHALL レビュー総数を表示する
5. WHEN 各企業をカード形式で表示する THEN レビュー一覧システム SHALL カテゴリ別評価（recommendation、foreign_support、company_culture、employee_relations、evaluation_system、promotion_treatment）を表示する
6. WHEN 各企業をカード形式で表示する THEN レビュー一覧システム SHALL 「詳細を見る」ボタンを表示する
7. WHEN 各企業をカード形式で表示する THEN レビュー一覧システム SHALL 「レビューを書く」ボタンを表示する
8. WHEN ユーザーが「詳細を見る」ボタンをクリックする THEN レビュー一覧システム SHALL 企業詳細ページへ遷移する
9. WHEN ユーザーが「レビューを書く」ボタンをクリックする THEN レビュー一覧システム SHALL レビュー投稿フォームページへ遷移する
