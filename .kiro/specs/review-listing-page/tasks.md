# 実装タスク

## 実装計画

本機能は、レビュー一覧ページの実装を段階的に進めます。レビュー投稿時の非同期集計処理、企業検索・フィルタリング機能、ページネーション、アクセス制御との統合を順次実装し、最後に既存データの初回集計を行います。

---

- [x] 1. レビュー集計サービスの実装
- [x] 1.1 企業単位のレビュー集計機能を実装
  - 企業IDを受け取り、当該企業のすべてのアクティブなレビューを取得する機能
  - カテゴリ別評価平均を計算する機能（None値を除外して有効な評価のみで平均）
  - 総合評価平均を計算する機能（全カテゴリの評価平均値の平均）
  - レビュー総数をカウントする機能
  - 最終レビュー投稿日時を取得する機能
  - _Requirements: 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10_

- [x] 1.2 企業の集計データを更新する機能を実装
  - 計算された集計データを企業レコードの review_summary フィールドに保存
  - 集計処理のエラーハンドリングとログ記録
  - 集計処理の冪等性を保証（複数回実行しても結果は同じ）
  - _Requirements: 1.11, 1.12_

- [x] 1.3 レビュー投稿時の非同期集計処理を統合
  - レビュー投稿完了後に企業IDを特定
  - spawn_callback または create_task を使用して非同期集計タスクを起動
  - 非同期集計タスクはレビュー投稿のレスポンスを待たずにバックグラウンドで実行
  - 集計エラー時でもレビュー投稿は成功として処理
  - _Requirements: 1.1, 1.2_

- [ ] 2. 企業検索サービスの拡張
- [x] 2.1 検索フィルタ構築機能を実装
  - 企業名による部分一致検索フィルタ（正規表現エスケープ処理を含む）
  - 所在地による部分一致検索フィルタ
  - 最低評価による範囲フィルタ（0.0〜5.0、0.5刻み）
  - 最高評価による範囲フィルタ
  - 複数フィルタ条件のAND結合
  - review_summary が存在する企業のみを対象とするフィルタ
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 5.3_

- [x] 2.2 ソート順序構築機能を実装
  - デフォルトソート：最新レビュー投稿順（last_review_date降順）
  - 評価順（高→低）：overall_average降順
  - 評価順（低→高）：overall_average昇順
  - レビュー数順：total_reviews降順
  - 企業名順：name昇順
  - ソートパラメータのバリデーション
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 2.3 ページネーション機能を実装
  - 1ページあたり20件の企業を取得
  - ページ番号によるオフセット計算（skip/limit）
  - 総件数の取得とページ数計算
  - ページ番号のバリデーション（1以上、最大ページ数以下）
  - _Requirements: 5.5, 5.6, 5.10_

- [x] 2.4 検索パラメータのバリデーション機能を実装
  - ページ番号のバリデーション（正の整数）
  - 1ページあたりの件数のバリデーション（1〜100）
  - 評価範囲のバリデーション（0.0〜5.0、min ≤ max）
  - バリデーションエラー時のエラーメッセージ生成
  - _Requirements: 3.3, 3.4_

- [x] 3. レビュー一覧ページハンドラの実装
- [x] 3.1 アクセス制御チェックを実装
  - セッションIDからユーザーIDを取得
  - AccessControlMiddleware を使用してアクセスレベルを判定
  - アクセスレベルに応じた処理分岐（denied / preview / full）
  - can_filter フラグの取得
  - _Requirements: 4.1, 4.2_

- [x] 3.2 検索パラメータの解析と処理を実装
  - クエリパラメータから検索条件を取得（name, location, min_rating, max_rating, page, limit, sort）
  - can_filter=false の場合、フィルタパラメータを無効化
  - パラメータのデフォルト値設定（page=1, limit=20, sort=rating_high）
  - 評価範囲の型変換（文字列→float）
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.2, 4.3_

- [x] 3.3 企業検索の実行とページレンダリングを実装
  - CompanySearchService を使用して企業を検索
  - 検索結果とページネーション情報を取得
  - アクセスレベルとcan_filterフラグをテンプレートに渡す
  - エラー時の処理（空のリストを表示、エラーログ記録）
  - _Requirements: 5.1, 5.2, 5.4, 5.11_

- [x] 4. レビュー一覧ページテンプレートの実装
- [x] 4.1 アクセス制御に応じたUI表示を実装
  - アクセス拒否時のメッセージ表示
  - プレビューモード通知の表示
  - フィルター機能無効化時の通知とUI無効化
  - _Requirements: 4.1, 4.4_

- [x] 4.2 検索フォームUIを実装
  - 企業名入力フィールド
  - 所在地入力フィールド
  - ソート順選択ドロップダウン
  - 最低評価スライダー（0.0〜5.0、0.5刻み）
  - 最高評価スライダー
  - 検索ボタンとリセットボタン
  - can_filter=false の場合、入力欄を無効化（disabled属性）
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.4_

- [x] 4.3 企業カード表示を実装
  - 企業名の表示
  - 所在地の表示
  - 総合評価の星マーク表示と数値表示
  - レビュー総数の表示
  - カテゴリ別評価の表示（6カテゴリ）
  - 「詳細を見る」ボタン（企業詳細ページへのリンク）
  - 「レビューを書く」ボタン（レビュー投稿フォームへのリンク）
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9_

- [x] 4.4 ページネーションUIを実装
  - ページ番号リンクの表示
  - 「前へ」ボタン（1ページ目では無効化）
  - 「次へ」ボタン（最終ページでは無効化）
  - 現在のページ番号をハイライト表示
  - ページ遷移時に検索パラメータを保持
  - _Requirements: 5.6, 5.7, 5.8, 5.9, 5.10_

- [x] 4.5 評価スライダーのJavaScript実装
  - スライダー操作時のリアルタイム値表示更新
  - 最低評価スライダーの値を hidden input に設定
  - 最高評価スライダーの値を hidden input に設定
  - 0.0の場合は「指定なし」と表示
  - 5.0の場合は「指定なし」と表示
  - _Requirements: 3.3, 3.4_

- [ ] 5. MongoDBインデックスの作成
- [x] 5.1 検索・ソート用インデックスを作成
  - review_summary.overall_average の降順インデックス
  - review_summary.total_reviews の降順インデックス
  - review_summary.last_updated の降順インデックス
  - 複合インデックス（overall_average + total_reviews）
  - 企業名と所在地の既存インデックスを確認
  - _Requirements: 全要件のパフォーマンス最適化_

- [x] 6. 既存データの初回集計スクリプトの実装
- [x] 6.1 初回集計バッチ処理を実装
  - レビューが存在する企業リストを取得
  - 各企業に対して集計処理を順次実行
  - 集計進捗をログに記録
  - エラー発生時も処理を継続（個別企業の集計失敗は記録のみ）
  - レート制限（100ms間隔で実行）
  - _Requirements: 1.1〜1.12（既存データへの適用）_

- [x] 6.2 集計結果のバリデーション機能を実装
  - すべての企業の review_summary が存在するか確認
  - total_reviews がレビュー実件数と一致するか確認
  - overall_average が 0.0〜5.0 の範囲内か確認
  - category_averages のすべてのカテゴリが計算されているか確認
  - バリデーション結果レポートの生成
  - _Requirements: 1.4, 1.5, 1.6, 1.10_

- [x] 7. ユニットテストの実装
- [x] 7.1 ReviewAggregationService のテストを実装
  - None値を含むレビューの集計テスト
  - 総合評価平均の計算テスト
  - レビューが0件の企業の集計テスト
  - カテゴリ別評価平均の計算テスト
  - 集計データの保存テスト
  - _Requirements: 1.3〜1.11_

- [x] 7.2 CompanySearchService のテストを実装
  - すべての検索パラメータのフィルタ構築テスト
  - ソート順序構築テスト（全5パターン）
  - パラメータバリデーションテスト（正常系・異常系）
  - 評価範囲の境界値テスト（min > max など）
  - _Requirements: 2.1〜2.6, 3.1〜3.5_

- [x] 7.3 ReviewListHandler のテストを実装
  - アクセス制御チェックのテスト（denied / preview / full）
  - can_filter=false の場合のフィルタ無効化テスト
  - 検索パラメータ解析のテスト
  - エラー時のハンドリングテスト
  - _Requirements: 4.1〜4.4_

- [x] 8. 統合テストの実装
- [x] 8.1 レビュー投稿から集計までのフローテストを実装
  - レビュー投稿が企業集計をトリガーすることを確認
  - 集計完了後に Company.review_summary が更新されることを確認
  - 複数レビューの集計が正しく計算されることを確認
  - 非同期実行でレビュー投稿のレスポンスが遅延しないことを確認
  - _Requirements: 1.1, 1.2, 1.3〜1.12_

- [x] 8.2 検索・フィルター統合テストを実装
  - 企業名フィルターが正しく機能することを確認
  - 評価範囲フィルターが正しく機能することを確認
  - ページネーションが正しく機能することを確認（重複なし）
  - ソート順序が正しく適用されることを確認
  - _Requirements: 2.1〜2.6, 3.1〜3.5, 5.5, 5.6, 5.10_

- [x] 9. E2Eテストの実装
- [x] 9.1 レビュー一覧ページの表示テストを実装
  - ページが正しく表示されることを確認
  - 検索フォームが表示されることを確認
  - 企業カードが表示されることを確認
  - アクセス制御に応じたUI変化を確認
  - _Requirements: 4.1〜4.4, 6.1〜6.9_

- [x] 9.2 検索フォーム送信テストを実装
  - フィルター値が保持されることを確認
  - ページネーションナビゲーションが機能することを確認
  - can_filter=false の場合にフィルターが無効化されることを確認
  - _Requirements: 3.1〜3.5, 4.2, 4.4, 5.6〜5.10_

- [x] 10. パフォーマンステストの実装
- [x] 10.1 集計処理のパフォーマンステストを実装
  - 100件のレビューの集計が100ms以内に完了することを確認
  - 集計処理の同時実行が正しく機能することを確認
  - _Requirements: 1.3〜1.12（パフォーマンス目標）_

- [x] 10.2 検索クエリのパフォーマンステストを実装
  - 1000件の企業データから検索クエリが200ms以内に完了することを確認
  - インデックスが正しく使用されることを確認（explain()で検証）
  - ページネーションクエリが50ms以内に完了することを確認
  - _Requirements: 2.1〜2.6, 3.1〜3.5, 5.1〜5.11（パフォーマンス目標）_
