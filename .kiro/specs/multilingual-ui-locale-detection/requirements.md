# Requirements Document

**Feature**: multilingual-ui-locale-detection
**作成日**: 2025-12-14
**言語**: 日本語

---

## Project Description (Input)

全ページの英語版・中国語・日本語版を作成したい。
User がまず表示言語を選択できるようにする。Userが選択した表示言語を表示する。
もし、Userが選択していない場合の初回アクセスは、Userのアクセス元のIP Address から、英語・中国語・日本語で表示すべきか判断する。中国語圏からのアクセスは、中国語を表示する。日本からのアクセスからは、日本語を表示する。それ以外のアクセスは、英語を表示する。
どのページでも、表示言語の選択は、Desktop Screen表示ならログインの上で、langで選択できる。
Mobile表示なら、BottomのMenuに、Home の右に、Langを選択できる。

URLの一部に言語を表示する。lang=enは、英語の表示を意味する。lang=jaは、日本語の表示を意味する。langの指定が無ければ、IPアドレスから判定して、各URLのLinkにlang=(判定した言語)を入れる。MenuでLangを変更すると、このURL埋め込みのlangが変わる。

---

## Requirements

### 1. 対応言語

#### 1.1 サポートする言語
**UBIQUITOUS**: システムは英語（English）、中国語（简体中文）、日本語の3言語をサポートしなければならない。

**UBIQUITOUS**: システムは全ページで選択された言語の表示を一貫して提供しなければならない。

#### 1.2 言語コード仕様
**UBIQUITOUS**: システムは以下の言語コードを使用しなければならない：
- 英語: `en`
- 中国語: `zh`
- 日本語: `ja`

### 2. 初回アクセス時の言語検出

#### 2.1 IP アドレスベースのロケール検出
**WHEN** ユーザーが初回アクセスを行う **THEN** システムはユーザーの言語設定がセッションに保存されていないことを検知しなければならない。

**WHEN** ユーザーの言語設定が存在しない場合 **THEN** システムはユーザーのIPアドレスから地理的位置を判定しなければならない。

**WHEN** IPアドレスから地理的位置が判定される **THEN** システムは以下のロジックで表示言語を決定しなければならない：
- 中国、香港、台湾、シンガポール（中国語圏）からのアクセス → 中国語（`zh`）
- 日本からのアクセス → 日本語（`ja`）
- その他の地域からのアクセス → 英語（`en`）

#### 2.2 IP アドレス取得
**UBIQUITOUS**: システムは以下の優先順位でクライアントのIPアドレスを取得しなければならない：
1. `X-Forwarded-For` ヘッダー（プロキシ・ロードバランサー経由の場合）
2. `X-Real-IP` ヘッダー（リバースプロキシ経由の場合）
3. TCP接続の送信元IPアドレス

#### 2.3 IP ロケーションデータベース
**UBIQUITOUS**: システムはIPアドレスから国・地域を判定するためのジオロケーションライブラリを使用しなければならない。

**UBIQUITOUS**: システムはIPロケーション判定が失敗した場合、デフォルトで英語（`en`）を表示しなければならない。

### 3. ユーザーによる言語選択

#### 3.1 言語選択機能の提供
**UBIQUITOUS**: システムは全ページでユーザーが表示言語を変更できる機能を提供しなければならない。

**WHEN** ユーザーが言語を選択する **THEN** システムは選択された言語をセッションに保存しなければならない。

**WHEN** ユーザーが言語を選択する **THEN** システムは現在のページを選択された言語で再読み込みしなければならない。

#### 3.2 デスクトップ画面での言語選択UI
**WHERE** デスクトップ表示（画面幅 768px 以上）の場合 **THEN** システムはログイン領域の上部に言語選択UIを配置しなければならない。

**WHERE** デスクトップ表示の場合 **THEN** システムは言語選択UIを以下のいずれかの形式で提供しなければならない：
- ドロップダウンメニュー形式
- 言語コードボタン形式（例: EN | 中 | 日）

#### 3.3 モバイル画面での言語選択UI
**WHERE** モバイル表示（画面幅 768px 未満）の場合 **THEN** システムは画面下部のボトムナビゲーションメニューに言語選択UIを配置しなければならない。

**WHERE** モバイル表示の場合 **THEN** システムは言語選択UIをホームボタンの右隣に配置しなければならない。

**WHERE** モバイル表示の場合 **THEN** システムは言語選択UIを以下のいずれかの形式で提供しなければならない：
- 言語アイコン（地球儀マーク等）タップでモーダル表示
- 言語コードボタン（例: EN | 中 | 日）

### 4. 言語設定の永続化

#### 4.1 セッションベースの言語保存
**WHEN** ユーザーが言語を選択する **THEN** システムは選択された言語コードをセッションクッキーに保存しなければならない。

**UBIQUITOUS**: システムは言語設定をセッションクッキーのキー名 `locale` または `language` で保存しなければならない。

#### 4.2 言語決定の優先順位
**WHEN** ユーザーがページにアクセスする **THEN** システムは以下の優先順位で表示言語を決定しなければならない：
1. URLクエリパラメータ `?lang=` の値（存在する場合）
2. セッションに保存された言語設定
3. IPアドレスベースの自動検出結果
4. デフォルト言語（英語 `en`）

#### 4.3 セッションの有効期限
**UBIQUITOUS**: システムは言語設定セッションクッキーの有効期限を30日間に設定しなければならない。

**WHEN** セッションクッキーが期限切れになる **THEN** システムは次回アクセス時にIPアドレスベースの言語検出を再実行しなければならない。

### 5. 多言語コンテンツの表示

#### 5.1 全ページの多言語対応
**UBIQUITOUS**: システムは以下の全ページで選択された言語のコンテンツを表示しなければならない：
- ホームページ（`/`）
- 企業一覧ページ（`/companies`）
- 企業詳細ページ（`/companies/{company_id}`）
- レビュー一覧ページ（`/reviews`）
- レビュー投稿ページ（`/reviews/create`）
- レビュー確認ページ（`/reviews/confirm`）
- レビュー詳細ページ（`/companies/{company_id}/reviews/{review_id}`）
- カテゴリ別レビュー一覧ページ（`/companies/{company_id}/reviews/by-category/{category}`）
- 求人一覧ページ（`/jobs`）
- ログイン・認証ページ（`/login`, `/register`）
- エラーページ（404, 500）

#### 5.2 静的テキストの多言語化
**UBIQUITOUS**: システムは以下の静的テキスト要素を選択された言語で表示しなければならない：
- ナビゲーションメニュー項目
- ページタイトル・見出し
- ボタンラベル
- フォームラベル・プレースホルダー
- エラーメッセージ・検証メッセージ
- ヘルプテキスト・説明文
- フッター情報

#### 5.3 動的コンテンツの多言語化
**UBIQUITOUS**: システムは以下の動的コンテンツを選択された言語で表示しなければならない：
- 企業説明文（多言語フィールド対応）
- レビューコメント（投稿時言語または翻訳版）
- 求人情報タイトル・説明
- カテゴリ名・項目名

**UBIQUITOUS**: システムは企業名を常に英語で表示しなければならない（言語設定に関係なく統一表記）。

#### 5.4 日付・時刻の表示形式
**WHEN** 選択言語が日本語の場合 **THEN** システムは日付を「YYYY年MM月DD日」形式で表示しなければならない。

**WHEN** 選択言語が英語の場合 **THEN** システムは日付を「Month DD, YYYY」形式で表示しなければならない。

**WHEN** 選択言語が中国語の場合 **THEN** システムは日付を「YYYY年MM月DD日」形式で表示しなければならない。

#### 5.5 数値の表示形式
**WHEN** 選択言語が日本語または中国語の場合 **THEN** システムは数値の桁区切りにカンマ（`,`）を使用しなければならない。

**WHEN** 選択言語が英語の場合 **THEN** システムは数値の桁区切りにカンマ（`,`）を使用しなければならない。

### 6. 翻訳データの管理

#### 6.1 翻訳ファイル構造
**UBIQUITOUS**: システムは言語別の翻訳データを以下の構造で管理しなければならない：
```
static/i18n/
├── en.json    # 英語翻訳
├── zh.json    # 中国語翻訳
└── ja.json    # 日本語翻訳
```

#### 6.2 翻訳キーの命名規則
**UBIQUITOUS**: システムは翻訳キーを以下の命名規則で定義しなければならない：
- ページ別のプレフィックス（例: `home.`, `companies.`, `reviews.`）
- 機能別のグループ化（例: `nav.`, `form.`, `error.`）
- スネークケース形式（例: `review_form.submit_button`）

#### 6.3 翻訳データのロード
**WHEN** アプリケーションが起動する **THEN** システムは全言語の翻訳データをメモリにロードしなければならない。

**WHEN** 翻訳データが更新される **THEN** システムはアプリケーション再起動後に変更を反映しなければならない。

### 7. 翻訳フォールバック

#### 7.1 キー不在時のフォールバック
**WHEN** 選択された言語で翻訳キーが見つからない場合 **THEN** システムは英語（`en`）の翻訳を表示しなければならない。

**WHEN** 英語でも翻訳キーが見つからない場合 **THEN** システムは翻訳キー名をそのまま表示しなければならない。

#### 7.2 空文字列のフォールバック
**WHEN** 翻訳データが空文字列の場合 **THEN** システムは英語の翻訳にフォールバックしなければならない。

### 8. テンプレートエンジン統合

#### 8.1 Jinja2 テンプレートでの多言語化
**UBIQUITOUS**: システムはJinja2テンプレート内で `t()` または `_()` 関数を使用して翻訳を適用しなければならない。

**UBIQUITOUS**: システムは全テンプレートに現在の言語コードを `current_locale` 変数として提供しなければならない。

#### 8.2 テンプレートフィルタの提供
**UBIQUITOUS**: システムは以下のJinja2カスタムフィルタを提供しなければならない：
- `translate(key)`: 翻訳キーを現在の言語の文字列に変換
- `format_date(date, locale)`: 日付を言語別フォーマットで表示
- `format_number(number, locale)`: 数値を言語別フォーマットで表示

#### 8.3 URL言語パラメータ付与のヘルパー関数
**UBIQUITOUS**: システムはJinja2テンプレート内でURLに言語パラメータを付与するヘルパー関数を提供しなければならない。

**UBIQUITOUS**: システムは `url_for_lang(path)` または類似の関数を提供し、指定されたパスに現在の言語パラメータを自動付与しなければならない。

**UBIQUITOUS**: システムは全テンプレートで `<a href="{{ url_for_lang('/companies') }}">` のような形式でリンクを記述できるようにしなければならない。

**WHEN** テンプレートで `url_for_lang('/reviews')` が呼ばれ、現在の言語が日本語の場合 **THEN** システムは `/reviews?lang=ja` を返さなければならない。

**WHEN** URLに既存のクエリパラメータが含まれる場合 **THEN** システムは `&lang=` の形式で言語パラメータを追加しなければならない（例: `/companies?industry=tech&lang=ja`）。

### 9. URLパラメータによる言語管理

#### 9.1 URL クエリパラメータ対応
**WHEN** URLに `?lang=en`、`?lang=zh`、または `?lang=ja` パラメータが含まれる場合 **THEN** システムは指定された言語を適用しセッションに保存しなければならない。

**WHEN** 無効な言語コードがURLパラメータで指定される場合 **THEN** システムは現在のセッション言語を維持しなければならない。

#### 9.2 全URLへの言語パラメータ自動付与
**UBIQUITOUS**: システムは全ページの全てのリンク（`<a href>`）に現在の言語を示す `lang` クエリパラメータを自動的に付与しなければならない。

**WHEN** ユーザーがページ内のリンクをクリックする **THEN** システムは遷移先URLに現在の言語パラメータを含めなければならない。

#### 9.3 言語パラメータの優先順位
**WHEN** URLに言語パラメータが存在する場合 **THEN** システムは以下の優先順位で表示言語を決定しなければならない：
1. URLクエリパラメータ `?lang=` の値
2. セッションに保存された言語設定
3. IPアドレスベースの自動検出結果
4. デフォルト言語（英語 `en`）

#### 9.4 初回アクセス時のURL言語パラメータ付与
**WHEN** ユーザーが言語パラメータなしでアクセスする **THEN** システムはIPアドレスから判定した言語を全てのリンクに `?lang=` パラメータとして付与しなければならない。

**WHEN** IPアドレスから日本を検出した場合 **THEN** システムは全リンクに `?lang=ja` を付与しなければならない。

**WHEN** IPアドレスから中国語圏を検出した場合 **THEN** システムは全リンクに `?lang=zh` を付与しなければならない。

**WHEN** IPアドレスからその他地域を検出した場合 **THEN** システムは全リンクに `?lang=en` を付与しなければならない。

#### 9.5 言語選択UI経由の言語変更時のURL更新
**WHEN** ユーザーが言語選択UIで言語を変更する **THEN** システムは現在のページURLの `lang` パラメータを新しい言語コードに更新してページを再読み込みしなければならない。

**WHEN** ユーザーが英語を選択する **THEN** システムは現在のURLの `lang` パラメータを `en` に変更しなければならない。

**WHEN** ユーザーが中国語を選択する **THEN** システムは現在のURLの `lang` パラメータを `zh` に変更しなければならない。

**WHEN** ユーザーが日本語を選択する **THEN** システムは現在のURLの `lang` パラメータを `ja` に変更しなければならない。

#### 9.6 URLパラメータとセッションの同期
**WHEN** URLに言語パラメータが含まれる場合 **THEN** システムはその言語をセッションに保存しなければならない。

**WHEN** セッションに保存された言語が変更される場合 **THEN** システムはページ内の全リンクの `lang` パラメータを新しい言語に更新しなければならない。

#### 9.7 外部リンクへの言語パラメータ付与除外
**UBIQUITOUS**: システムは外部サイトへのリンク（`href` が `http://` または `https://` で始まり、かつ自サイトドメイン外）には言語パラメータを付与してはならない。

**UBIQUITOUS**: システムは内部リンク（相対パスまたは自サイトドメイン）のみに言語パラメータを付与しなければならない。

#### 9.8 特殊URLへの言語パラメータ処理
**WHEN** URLがアンカーリンク（`#` で始まる）の場合 **THEN** システムは言語パラメータを付与せず、現在ページ内でのスクロールのみを実行しなければならない。

**WHEN** URLが `javascript:` プロトコルの場合 **THEN** システムは言語パラメータを付与してはならない。

**WHEN** URLがファイルダウンロードリンク（`.pdf`, `.csv`, `.xlsx` 等）の場合 **THEN** システムは言語パラメータを付与してもよいが、ダウンロード処理に影響を与えてはならない。

#### 9.9 フォーム送信時の言語パラメータ処理
**WHEN** フォームがGETメソッドで送信される場合 **THEN** システムはフォームアクションURLに現在の言語パラメータを含めなければならない。

**WHEN** フォームがPOSTメソッドで送信される場合 **THEN** システムはフォームアクションURLに現在の言語パラメータを含めなければならない。

**WHEN** フォーム送信後にリダイレクトが発生する場合 **THEN** システムはリダイレクト先URLに言語パラメータを保持しなければならない。

### 10. パフォーマンス要件

#### 10.1 言語切り替え時の応答時間
**WHEN** ユーザーが言語を切り替える **THEN** システムは1秒以内にページを再読み込みしなければならない。

#### 10.2 IPロケーション検出の応答時間
**WHEN** システムがIPアドレスからロケールを検出する **THEN** システムは500ミリ秒以内に判定を完了しなければならない。

**WHEN** IPロケーション検出がタイムアウトする場合 **THEN** システムはデフォルト言語（英語）を即座に適用しなければならない。

### 11. セキュリティ要件

#### 11.1 言語コードの検証
**WHEN** ユーザーが言語を選択する **THEN** システムは言語コードがホワイトリスト（`en`, `zh`, `ja`）に含まれることを検証しなければならない。

**WHEN** URLパラメータで言語コードが指定される **THEN** システムは言語コードがホワイトリスト（`en`, `zh`, `ja`）に含まれることを検証しなければならない。

**WHEN** 無効な言語コードが送信される場合 **THEN** システムはリクエストを拒否せず、デフォルト言語（英語）または現在のセッション言語を維持しなければならない。

**WHEN** URLパラメータに不正な文字列が含まれる場合（例: `?lang=<script>`） **THEN** システムはパラメータを無視し、セッション言語またはデフォルト言語を使用しなければならない。

#### 11.2 セッションクッキーのセキュリティ
**UBIQUITOUS**: システムは言語設定セッションクッキーに以下の属性を設定しなければならない：
- `HttpOnly=true`: JavaScript からのアクセスを防止
- `SameSite=Lax`: CSRF 攻撃を軽減
- `Secure=true`（HTTPS環境のみ）: 暗号化通信のみで送信

#### 11.3 XSS 対策
**UBIQUITOUS**: システムは翻訳テキストを出力する際、HTMLエスケープ処理を適用しなければならない。

**UBIQUITOUS**: システムは翻訳データにHTMLタグが含まれる場合、信頼できるコンテンツとして明示的にマークされたもののみレンダリングしなければならない。

### 12. アクセシビリティ要件

#### 12.1 HTML lang 属性の設定
**UBIQUITOUS**: システムは `<html>` タグの `lang` 属性を現在の言語コードに設定しなければならない。
- 日本語: `<html lang="ja">`
- 英語: `<html lang="en">`
- 中国語: `<html lang="zh">`

#### 12.2 言語切り替えUIのアクセシビリティ
**UBIQUITOUS**: システムは言語選択UIに `aria-label` 属性を設定しなければならない（例: `aria-label="言語を選択"`）。

**UBIQUITOUS**: システムは言語選択UIをキーボード操作（Tab, Enter）でアクセス可能にしなければならない。

### 13. エラーハンドリング

#### 13.1 翻訳データロードエラー
**WHEN** 翻訳データファイルのロードに失敗する場合 **THEN** システムはエラーログを記録し、英語のデフォルト翻訳で動作を継続しなければならない。

#### 13.2 IPロケーション検出エラー
**WHEN** IPロケーション検出に失敗する場合 **THEN** システムはエラーログを記録し、デフォルト言語（英語）を適用しなければならない。

#### 13.3 セッション保存エラー
**WHEN** 言語設定のセッション保存に失敗する場合 **THEN** システムはエラーログを記録し、ユーザーに一時的なエラーメッセージを表示しなければならない。

### 14. テスト要件

#### 14.1 言語切り替えのE2Eテスト
**UBIQUITOUS**: システムは以下のE2Eテストを提供しなければならない：
- デスクトップ画面での言語切り替え動作確認
- モバイル画面での言語切り替え動作確認
- 全3言語での主要ページ表示確認
- セッション永続化の動作確認

#### 14.2 IPロケーション検出のユニットテスト
**UBIQUITOUS**: システムは以下のユニットテストを提供しなければならない：
- 中国・香港・台湾・シンガポールIPからの中国語検出
- 日本IPからの日本語検出
- その他地域IPからの英語検出
- IPロケーション検出失敗時のフォールバック動作

#### 14.3 翻訳データの完全性テスト
**UBIQUITOUS**: システムは全言語ファイル間で翻訳キーの一貫性を検証するテストを提供しなければならない。

**WHEN** 翻訳キーが一部の言語でのみ定義されている場合 **THEN** テストは警告を出力しなければならない。

#### 14.4 URL言語パラメータのE2Eテスト
**UBIQUITOUS**: システムは以下のURL言語パラメータ関連のE2Eテストを提供しなければならない：
- `?lang=en` パラメータ付きアクセスで英語表示されることを確認
- `?lang=zh` パラメータ付きアクセスで中国語表示されることを確認
- `?lang=ja` パラメータ付きアクセスで日本語表示されることを確認
- ページ内の全リンクに現在の言語パラメータが付与されていることを確認
- 言語選択UI経由の言語変更でURLパラメータが更新されることを確認
- 外部リンクには言語パラメータが付与されないことを確認

#### 14.5 URL言語パラメータのユニットテスト
**UBIQUITOUS**: システムは以下のユニットテストを提供しなければならない：
- URL言語パラメータ抽出ロジックのテスト
- 内部リンク判定ロジックのテスト
- 言語パラメータ付与除外パターン（アンカー、javascript:等）のテスト
- フォームアクションURLへの言語パラメータ付与のテスト

### 15. 既存機能への影響

#### 15.1 レビューシステムとの統合
**UBIQUITOUS**: システムは既存の多言語レビューフォーム機能と言語設定を統合しなければならない。

**WHEN** ユーザーがサイト全体の言語を選択する **THEN** システムはレビューフォームのデフォルト言語を同じ言語に設定しなければならない。

#### 15.2 OAuth認証との統合
**UBIQUITOUS**: システムはOAuth認証フロー中でも言語設定を維持しなければならない。

**WHEN** ユーザーがOAuthプロバイダーから戻る **THEN** システムは認証前の言語設定を復元しなければならない。

#### 15.3 既存データベーススキーマへの影響
**UBIQUITOUS**: システムは既存のMongoDBスキーマを以下の多言語フィールドに対応させなければならない：
- `Company` コレクション: `name`（英語のみ）、`description_en`, `description_zh`, `description_ja`
- `Review` コレクション: 既存の多言語フィールド（`comment_ja`, `comment_en`, `comment_zh`）を活用

**UBIQUITOUS**: システムは企業名フィールド（`name`）を多言語化せず、英語表記のみを保持しなければならない。

### 16. 移行要件

#### 16.1 段階的な多言語化実装
**UBIQUITOUS**: システムは以下の優先順位で多言語化を実装しなければならない：
1. 言語検出・選択機能の実装
2. 主要ページの静的テキスト翻訳
3. 動的コンテンツの多言語対応
4. エラーページ・ヘルプテキストの翻訳

#### 16.2 既存日本語コンテンツの扱い
**UBIQUITOUS**: システムは現在日本語で記述された静的テキストを翻訳ファイル `ja.json` に移行しなければならない。

**UBIQUITOUS**: システムは既存の日本語テキストを英語・中国語に翻訳し、対応する翻訳ファイルに追加しなければならない。
