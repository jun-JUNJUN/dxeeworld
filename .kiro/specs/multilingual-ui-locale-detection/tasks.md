# 実装タスク

**Feature**: multilingual-ui-locale-detection
**作成日**: 2025-12-15
**言語**: 日本語

---

## 実装計画

このタスクリストは、多言語UI・自動ロケール検出機能の実装を段階的に進めるためのものです。各タスクは1〜3時間程度で完了できる単位に分割されており、要件定義書の全75要件をカバーしています。

---

- [ ] 1. プロジェクト基盤の準備とライブラリ統合
- [ ] 1.1 新規依存ライブラリの追加とGeoIP2データベース配置
  - `pyproject.toml` に `geoip2 >= 5.2.0` と `babel >= 2.14.0` を追加
  - GeoLite2 Country データベースをMaxMindから取得し `static/geo/` に配置
  - ライブラリインストールと動作確認
  - _Requirements: 2.3, 10.2_

- [ ] 1.2 翻訳データファイルの初期構造作成
  - `static/i18n/` ディレクトリを作成
  - `en.json`, `ja.json`, `zh.json` の空骨格ファイルを作成
  - 基本的なナビゲーション翻訳キーを追加（nav.home, nav.companies, nav.reviews, nav.jobs）
  - _Requirements: 6.1, 6.2_

- [ ] 2. バックエンドサービスの実装
- [ ] 2.1 LocaleDetectionServiceの実装
  - IPアドレスから国コードを検出するロジック
  - 国コードを言語コード（en/ja/zh）にマッピングする機能
  - 日本、中国語圏（CN/HK/TW/SG）、その他地域の判定
  - GeoIP2データベースの初期化と終了処理
  - エラー時のフォールバック（デフォルト英語）
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 2.2 I18nServiceの実装
  - アプリケーション起動時に全言語の翻訳データをメモリロード
  - 翻訳キーから文字列を取得する機能（ネストキー対応）
  - 翻訳キー不在時の英語フォールバック処理
  - 英語でも見つからない場合はキー名を返却
  - _Requirements: 5.2, 6.3, 7.1, 7.2_

- [ ] 2.3 I18nServiceの日付・数値フォーマット機能
  - Babelを使用した言語別日付フォーマット（ja: YYYY年MM月DD日, en: Month DD, YYYY）
  - 言語別数値フォーマット（桁区切りカンマ）
  - 言語コードからBabelロケール名へのマッピング
  - _Requirements: 5.4, 5.5_

- [ ] 2.4 URLLanguageServiceの実装
  - URLに言語クエリパラメータを追加する機能
  - 既存の言語パラメータを更新する機能
  - URLから言語パラメータを抽出する機能
  - 内部リンクと外部リンクを判定する機能
  - アンカーリンクやjavascript:プロトコルを除外する処理
  - _Requirements: 9.1, 9.2, 9.7, 9.8_

- [ ] 3. BaseHandlerのミドルウェア拡張
- [ ] 3.1 prepare()フックによる言語検出ロジック実装
  - `BaseHandler.prepare()` メソッドの追加
  - 言語検出の優先順位実装（URL → セッション → IP → デフォルト）
  - URLパラメータ `?lang=` の確認と検証
  - セッションクッキーからの言語取得
  - IPアドレスベースの自動検出呼び出し
  - デフォルト言語（英語）の設定
  - _Requirements: 4.2, 9.3, 9.4_

- [ ] 3.2 セッション管理とクッキー設定
  - 言語設定をセキュアクッキーに保存（有効期限30日）
  - HttpOnly、SameSite=Lax、Secure（HTTPS時）属性の設定
  - セッション保存エラー時のログ記録
  - _Requirements: 4.1, 4.3, 11.2, 13.3_

- [ ] 3.3 言語コードのホワイトリスト検証
  - 言語コードが en/ja/zh のいずれかであることを確認
  - 不正な文字列（XSS攻撃ベクター）を拒否
  - 無効なコードの場合は現在のセッション言語を維持
  - _Requirements: 11.1_

- [ ] 3.4 テンプレートコンテキストへの変数提供
  - `get_template_namespace()` メソッドの拡張
  - `current_locale`, `locale_source` 変数を全テンプレートに渡す
  - `t()` 翻訳関数をJinja2テンプレートで利用可能にする
  - `url_for_lang()` URL言語パラメータ関数を提供
  - `format_date()` 日付フォーマット関数を提供
  - _Requirements: 8.1, 8.2, 8.3_

- [ ] 4. アプリケーション初期化処理の統合
- [ ] 4.1 サービスインスタンスの初期化とアプリケーションへの登録
  - `app.py` の起動処理で全サービスを初期化
  - LocaleDetectionService、I18nService、URLLanguageServiceのインスタンス作成
  - GeoIP2データベースと翻訳データの初期ロード
  - 初期化エラー時のログ記録とフォールバック
  - アプリケーション終了時のリソースクリーンアップ
  - _Requirements: 2.3, 6.3, 13.1_

- [ ] 4.2 Jinja2カスタムフィルタの登録
  - `t()` フィルタ: 翻訳キーを現在の言語文字列に変換
  - `url_for_lang()` フィルタ: URLに現在の言語パラメータを付与
  - `format_date()` フィルタ: 日付を言語別フォーマットで表示
  - フィルタのエラーハンドリング
  - _Requirements: 8.1, 8.2_

- [ ] 5. 静的テキストの翻訳ファイル作成
- [ ] 5.1 ナビゲーションメニューの翻訳
  - nav.home, nav.companies, nav.reviews, nav.jobs の翻訳
  - nav.login, nav.register, nav.logout の翻訳
  - nav.language_selector, nav.select_language の翻訳
  - 英語、中国語、日本語の3言語すべてに対応
  - _Requirements: 5.2_

- [ ] 5.2 ホームページの翻訳
  - home.title, home.subtitle, home.cta_button の翻訳
  - ホームページのメインメッセージと行動喚起ボタン
  - 3言語対応
  - _Requirements: 5.1, 5.2_

- [ ] 5.3 企業一覧ページの翻訳
  - companies.title, companies.search_placeholder の翻訳
  - companies.filter_industry, companies.filter_location の翻訳
  - companies.no_results の翻訳
  - 検索・フィルター関連の全テキスト
  - _Requirements: 5.1, 5.2_

- [ ] 5.4 レビューシステムの翻訳
  - reviews.title, reviews.write_review の翻訳
  - reviews.employment_status, reviews.overall_rating の翻訳
  - reviews.submit, reviews.confirm の翻訳
  - レビューフォーム関連の全テキスト
  - _Requirements: 5.1, 5.2_

- [ ] 5.5 フォーム・ボタン共通要素の翻訳
  - form.submit, form.cancel, form.save の翻訳
  - form.edit, form.delete, form.search の翻訳
  - 全フォームで共通利用される要素
  - _Requirements: 5.2_

- [ ] 5.6 エラーメッセージの翻訳
  - errors.not_found, errors.server_error の翻訳
  - errors.unauthorized, errors.validation_failed の翻訳
  - エラーページと検証エラーメッセージ
  - _Requirements: 5.2_

- [ ] 5.7 企業詳細ページの翻訳
  - 企業情報セクションの見出しとラベル
  - レビューセクションの見出し
  - アクションボタンのラベル
  - _Requirements: 5.1, 5.2_

- [ ] 5.8 求人ページとその他ページの翻訳
  - jobs.title, jobs.search_placeholder の翻訳
  - 認証関連ページの翻訳
  - フッター情報の翻訳
  - _Requirements: 5.1, 5.2_

- [ ] 6. テンプレートファイルの多言語化
- [ ] 6.1 base.htmlテンプレートの多言語化
  - HTML lang属性を `{{ current_locale }}` に設定
  - ナビゲーションメニューを `{{ t('nav.home') }}` 形式に置換
  - 全リンクを `{{ url_for_lang('/path') }}` 形式に更新
  - ハードコードされた日本語テキストを翻訳キーに置換
  - _Requirements: 5.2, 8.1, 9.2, 12.1_

- [ ] 6.2 home.htmlテンプレートの多言語化
  - ページタイトル・見出しを翻訳キーに置換
  - 説明文・CTAボタンを翻訳キーに置換
  - リンクに言語パラメータを付与
  - _Requirements: 5.1, 5.2, 8.1_

- [ ] 6.3 companies/list.htmlテンプレートの多言語化
  - 検索フォームのプレースホルダーとラベルを翻訳キーに置換
  - フィルター項目を翻訳キーに置換
  - 「結果なし」メッセージを翻訳キーに置換
  - 全リンクに言語パラメータを付与
  - _Requirements: 5.1, 5.2, 8.1, 9.2_

- [ ] 6.4 companies/detail.htmlテンプレートの多言語化
  - 企業名は常に英語で表示（多言語化なし）
  - 企業説明文は `description_{{ current_locale }}` フィールドを使用
  - セクション見出しとラベルを翻訳キーに置換
  - レビュー表示部分の多言語化
  - _Requirements: 5.1, 5.3, 8.1_

- [ ] 6.5 reviews/create.htmlテンプレートの多言語化
  - フォームラベルとプレースホルダーを翻訳キーに置換
  - 既存の多言語レビューフォーム機能と統合
  - サイト全体の言語設定をレビューフォームのデフォルト言語に反映
  - ボタンラベルを翻訳キーに置換
  - _Requirements: 5.1, 5.2, 15.1_

- [ ] 6.6 reviews/confirm.htmlテンプレートの多言語化
  - 確認画面の見出しとメッセージを翻訳キーに置換
  - レビュー内容表示部分の多言語化
  - アクションボタンの翻訳
  - _Requirements: 5.1, 5.2_

- [ ] 6.7 reviews/list.htmlとedit.htmlの多言語化
  - レビュー一覧ページの見出しとフィルターを翻訳キーに置換
  - レビュー編集ページのフォーム要素を翻訳キーに置換
  - レビューコメントは既存の多言語フィールドを活用
  - _Requirements: 5.1, 5.3_

- [ ] 6.8 レビュー詳細ページの多言語化
  - 個別レビュー詳細ページ (`/companies/{id}/reviews/{review_id}`) の翻訳
  - カテゴリ別レビュー一覧ページ (`/companies/{id}/reviews/by-category/{category}`) の翻訳
  - 戻るリンク・ナビゲーションの翻訳
  - _Requirements: 5.1_

- [ ] 6.9 jobs/list.htmlテンプレートの多言語化
  - 求人一覧ページの見出しと検索フォームを翻訳キーに置換
  - 求人情報の表示部分を多言語化
  - フィルター項目の翻訳
  - _Requirements: 5.1, 5.2_

- [ ] 6.10 エラーページテンプレートの多言語化
  - 404.html と 500.html のエラーメッセージを翻訳キーに置換
  - エラーページのタイトルと説明を多言語化
  - ホームへ戻るリンクに言語パラメータを付与
  - _Requirements: 5.1, 5.2_

- [ ] 7. 言語選択UIコンポーネントの実装
- [ ] 7.1 デスクトップ版言語選択UIの実装
  - ログインパネル上部に言語選択ドロップダウンまたはボタンを配置
  - 現在の言語を選択状態で表示
  - 英語・中国語・日本語の3つの選択肢を提供
  - ARIA属性（aria-label）によるアクセシビリティ対応
  - 画面幅768px以上でのみ表示
  - _Requirements: 3.2, 12.2_

- [ ] 7.2 モバイル版言語選択UIの実装
  - ボトムナビゲーションバーのHomeボタン右隣に配置
  - 言語コード（EN/中/日）またはアイコン形式で表示
  - タップでモーダルまたはドロップアップメニューを表示
  - 画面幅768px未満でのみ表示
  - _Requirements: 3.3, 12.2_

- [ ] 7.3 JavaScript言語切り替えロジックの実装
  - 言語選択時に現在のURLの `lang` パラメータを更新
  - URLパラメータ更新後にページをリロード
  - モバイル版の言語選択モーダルの表示・非表示制御
  - キーボード操作（Tab, Enter）のサポート
  - _Requirements: 3.1, 9.5, 12.2_

- [ ] 8. フォーム送信時の言語パラメータ処理
- [ ] 8.1 GETフォームの言語パラメータ処理
  - 検索フォームなどGETメソッドのフォームアクションURLに言語パラメータを含める
  - JavaScriptでフォーム送信前にURLパラメータを追加
  - _Requirements: 9.9_

- [ ] 8.2 POSTフォームの言語パラメータ処理
  - レビュー投稿フォームなどPOSTメソッドのフォームアクションURLに言語パラメータを含める
  - リダイレクト先URLに言語パラメータを保持
  - _Requirements: 9.9_

- [ ] 9. OAuth認証との統合
- [ ] 9.1 OAuth認証フロー中の言語設定維持
  - OAuth認証開始前に現在の言語をセッションまたはstateパラメータに保存
  - OAuth認証後のコールバック処理で言語設定を復元
  - リダイレクトURLに言語パラメータを含める
  - _Requirements: 15.2_

- [ ] 10. データベーススキーマ対応の確認
- [ ] 10.1 Companyモデルの多言語フィールド確認
  - `name` フィールドが英語のみであることを確認（多言語化不要）
  - `description_en`, `description_ja`, `description_zh` フィールドの存在確認
  - テンプレートで `description_{{ current_locale }}` を使用できることを確認
  - _Requirements: 5.3, 15.3_

- [ ] 10.2 Reviewモデルの既存多言語フィールド活用
  - `comment_ja`, `comment_en`, `comment_zh` フィールドの存在確認
  - 既存のDeepL翻訳サービスとの統合を維持
  - レビュー表示時に現在の言語に対応するコメントフィールドを使用
  - _Requirements: 5.3, 15.3_

- [ ] 11. ユニットテストの作成
- [ ] 11.1 LocaleDetectionServiceのユニットテスト
  - 日本IPから日本語検出のテスト
  - 中国・香港・台湾・シンガポールIPから中国語検出のテスト
  - その他地域IPから英語検出のテスト
  - 国コード→言語コードマッピングのテスト
  - IPロケーション検出失敗時のフォールバックテスト
  - 言語コードのホワイトリスト検証テスト
  - _Requirements: 14.2_

- [ ] 11.2 I18nServiceのユニットテスト
  - 翻訳キー取得成功のテスト（全3言語）
  - ネストされた翻訳キーの取得テスト
  - 翻訳キー不在時の英語フォールバックテスト
  - 英語でも見つからない場合のキー名返却テスト
  - 日付フォーマットのテスト（全3言語）
  - 数値フォーマットのテスト
  - _Requirements: 14.3_

- [ ] 11.3 URLLanguageServiceのユニットテスト
  - シンプルなURLへの言語パラメータ追加テスト
  - 既存クエリパラメータ付きURLへの言語パラメータ追加テスト
  - 言語パラメータ更新のテスト
  - URLからの言語パラメータ抽出テスト
  - 内部リンク判定のテスト（相対パス、絶対URL）
  - 外部リンク判定のテスト
  - アンカーリンク・javascriptプロトコル除外のテスト
  - _Requirements: 14.5_

- [ ] 11.4 BaseHandler言語検出ロジックのユニットテスト
  - URLパラメータ優先のテスト
  - セッションクッキーフォールバックのテスト
  - IPロケーション検出フォールバックのテスト
  - デフォルト言語適用のテスト
  - 不正な言語コードの拒否テスト
  - セッションクッキー保存のテスト
  - _Requirements: 14.2_

- [ ] 11.5 翻訳データ整合性のユニットテスト
  - en.json、ja.json、zh.json 間での翻訳キーの一致確認
  - 一部の言語でのみ定義されているキーの検出
  - 欠損キーの警告出力
  - _Requirements: 14.3_

- [ ] 12. 統合テストの作成
- [ ] 12.1 言語検出統合テスト
  - URLパラメータ `?lang=ja` 付きアクセスで日本語表示されることを確認
  - URLパラメータ `?lang=zh` 付きアクセスで中国語表示されることを確認
  - URLパラメータ `?lang=en` 付きアクセスで英語表示されることを確認
  - セッションクッキー経由の言語設定確認
  - パラメータなしアクセスでのデフォルト言語確認
  - _Requirements: 14.4_

- [ ] 12.2 言語切り替え統合テスト
  - 言語選択UIからの切り替え動作確認
  - URL言語パラメータの更新確認
  - セッションクッキーの更新確認
  - ページリロード後の言語維持確認
  - _Requirements: 14.1_

- [ ] 13. E2Eテストの作成
- [ ] 13.1 デスクトップ言語切り替えE2Eテスト
  - Playwright使用
  - デスクトップ画面で言語ドロップダウンを操作
  - 全3言語での主要ページ表示確認
  - ナビゲーションメニューの翻訳確認
  - _Requirements: 14.1_

- [ ] 13.2 モバイル言語切り替えE2Eテスト
  - Playwright使用
  - モバイル画面サイズでの言語ボタン操作
  - 言語選択モーダルの動作確認
  - 全3言語での主要ページ表示確認
  - _Requirements: 14.1_

- [ ] 13.3 全リンク言語パラメータ付与E2Eテスト
  - ページ内の全内部リンクに現在の言語パラメータが付与されていることを確認
  - 外部リンクには言語パラメータが付与されていないことを確認
  - アンカーリンクが除外されていることを確認
  - _Requirements: 14.4_

- [ ] 13.4 セッション永続化E2Eテスト
  - 言語選択後、ブラウザをリロードして言語が維持されることを確認
  - 別ページに遷移しても言語が維持されることを確認
  - 30日間のセッションクッキー有効期限確認
  - _Requirements: 14.1_

- [ ] 14. パフォーマンステストの作成
- [ ] 14.1 IPロケーション検出のパフォーマンステスト
  - IP検出処理が500ミリ秒以内に完了することを確認
  - 1000回の検出処理の平均レイテンシ測定
  - _Requirements: 10.2_

- [ ] 14.2 翻訳ルックアップのパフォーマンステスト
  - 翻訳キー取得が1ミリ秒以内に完了することを確認
  - 1000回のルックアップ処理の平均レイテンシ測定
  - _Requirements: 10.1_

- [ ] 14.3 言語切り替え応答時間のE2Eテスト
  - 言語切り替えからページ再読み込み完了まで1秒以内を確認
  - Playwright使用
  - _Requirements: 10.1_

- [ ] 15. 本番環境準備とデプロイ
- [ ] 15.1 環境変数とGeoIP2データベースの配置
  - 本番環境に GeoLite2 Country データベースを配置
  - 環境変数で GeoIP2 データベースパスを設定可能にする
  - MaxMind ライセンスキーの設定（必要な場合）
  - _Requirements: 2.3_

- [ ] 15.2 本番環境でのHTTPS設定確認
  - セキュアクッキーの `Secure=true` 属性が有効になることを確認
  - HTTPS環境での動作テスト
  - _Requirements: 11.2_

- [ ] 15.3 本番環境デプロイとスモークテスト
  - アプリケーションを本番環境にデプロイ
  - 全3言語でのアクセステスト
  - エラーログの確認
  - パフォーマンスモニタリング設定
  - _Requirements: All_

---

## 要件カバレッジ確認

全75要件が上記タスクでカバーされています：

- **対応言語** (1.1-1.2): タスク 1.2, 2.1, 5.1-5.8
- **IP検出** (2.1-2.3): タスク 2.1, 4.1, 11.1
- **言語選択** (3.1-3.3): タスク 7.1-7.3
- **セッション管理** (4.1-4.3): タスク 3.2, 3.4
- **コンテンツ多言語化** (5.1-5.5): タスク 5.1-5.8, 6.1-6.10
- **翻訳データ管理** (6.1-6.3): タスク 1.2, 2.2, 4.1
- **翻訳フォールバック** (7.1-7.2): タスク 2.2, 11.2
- **テンプレート統合** (8.1-8.3): タスク 3.4, 4.2, 6.1-6.10
- **URLパラメータ** (9.1-9.9): タスク 2.4, 3.1, 7.3, 8.1-8.2
- **パフォーマンス** (10.1-10.2): タスク 14.1-14.3
- **セキュリティ** (11.1-11.3): タスク 3.2, 3.3, 15.2
- **アクセシビリティ** (12.1-12.2): タスク 6.1, 7.1-7.2
- **エラーハンドリング** (13.1-13.3): タスク 2.1-2.4, 4.1
- **テスト** (14.1-14.5): タスク 11.1-11.5, 12.1-12.2, 13.1-13.4
- **既存機能統合** (15.1-15.3): タスク 6.5, 9.1, 10.1-10.2
- **移行** (16.1-16.2): タスク 6.1-6.10

---

## 実装順序の推奨

1. **Phase 1 (タスク 1-4)**: 基盤構築 - サービス実装とミドルウェア統合
2. **Phase 2 (タスク 5-6)**: 静的テキスト翻訳とテンプレート多言語化
3. **Phase 3 (タスク 7-10)**: UI統合と既存機能との統合
4. **Phase 4 (タスク 11-15)**: テスト作成と本番デプロイ

各フェーズ完了後に動作確認を行い、問題があれば前フェーズに戻ってデバッグすることを推奨します。
