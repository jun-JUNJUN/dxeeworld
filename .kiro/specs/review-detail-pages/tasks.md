# 実装タスク

## 概要

本タスクリストは、レビュー詳細ページ機能の実装を段階的に進めるためのものです。要件定義書と設計書に基づき、以下の優先順位で実装を進めます：

1. ユーザー匿名化サービスの実装（基盤）
2. 個別レビュー詳細ページの実装
3. 質問別レビュー一覧ページの実装
4. テンプレートとルーティング設定
5. テストの実装

---

## タスク一覧

- [x] 1. ユーザー匿名化サービスの実装
- [x] 1.1 匿名化サービスの基本実装
  - ユーザーIDからSHA-256ハッシュ値を生成する機能
  - ハッシュ値をアルファベット（A-Z）に変換する機能
  - 「ユーザー{アルファベット}」形式で匿名化表示を返す機能
  - ソルト機能を用いたハッシュ値のカスタマイズ対応
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 1.2 レビューオブジェクトの匿名化機能
  - レビューオブジェクトを受け取り、ユーザー情報を匿名化する機能
  - 匿名化済みデータを辞書形式で返す機能
  - 在籍状況、勤務期間、評価スコア、コメントなどを含む完全なデータ構造の構築
  - プレビューモード時のコメントマスキング機能
  - _Requirements: 3.2, 4.3_

- [x] 2. 個別レビュー詳細ページの実装
- [x] 2.1 リクエストハンドラーの基本実装
  - URLパスパラメータ（company_id, review_id）を受け取るハンドラー
  - アクセス制御ミドルウェアとの統合（PREVIEW以上のアクセスレベル要求）
  - データベースサービスと匿名化サービスの初期化
  - _Requirements: 1.1, 4.1, 4.2_

- [x] 2.2 レビューデータ取得とバリデーション
  - 指定されたレビューIDでデータベースからレビューを取得する機能
  - レビューの存在チェックと is_active フラグの検証
  - 企業IDとレビューの company_id の一致検証
  - 企業名の取得機能
  - _Requirements: 1.1, 1.2, 8.1, 8.2_

- [x] 2.3 アクセスレベルに応じたレンダリング処理
  - アクセスレベル（PREVIEW, FULL, CRAWLER）の判定
  - プレビューモード時のコメントマスキング処理
  - フルアクセスモード時の全詳細表示
  - CTAボタンの表示制御（プレビュー時のみ）
  - _Requirements: 4.2, 4.3, 4.4, 4.6_

- [x] 2.4 エラーハンドリングの実装
  - 404エラー: レビューが見つからない場合の処理
  - 404エラー: 企業が見つからない場合の処理
  - 500エラー: データベースエラー時の処理
  - 適切なログ出力（info, warning, exception）
  - _Requirements: 8.1, 8.2, 8.4, 8.6_

- [ ] 3. 質問別レビュー一覧ページの実装
- [ ] 3.1 リクエストハンドラーの基本実装
  - URLパスパラメータ（company_id, category_name）を受け取るハンドラー
  - クエリパラメータ（page）の取得とデフォルト値設定
  - アクセス制御ミドルウェアとの統合
  - _Requirements: 2.1, 4.1_

- [ ] 3.2 カテゴリ名のバリデーション
  - 6つの有効なカテゴリ名（recommendation, foreign_support, など）のホワイトリスト検証
  - 無効なカテゴリ名の場合の400エラー返却
  - カテゴリ名の日本語表示名へのマッピング機能
  - _Requirements: 2.3, 2.4, 8.3_

- [ ] 3.3 レビューリストの取得とページネーション
  - 指定カテゴリに回答したレビューの総件数取得機能
  - ページ番号から skip/limit パラメータを計算する機能
  - 20件ずつレビューを取得する機能（投稿日時降順）
  - ページネーション情報（総ページ数、前/次ページ有無）の計算
  - _Requirements: 2.1, 2.8, 2.9, 2.10, 7.4_

- [ ] 3.4 複数レビューの匿名化処理
  - 取得した全レビューに対する匿名化サービスの適用
  - アクセスレベルに応じたコメントマスキング
  - 未回答レビューの適切な表示処理
  - _Requirements: 2.6, 2.7, 3.2, 4.3_

- [ ] 3.5 エラーハンドリングとエッジケース処理
  - 400エラー: 無効なカテゴリ名の処理
  - 400エラー: 無効なページ番号の処理
  - 404エラー: 企業が見つからない場合の処理
  - レビュー0件時の「レビューがありません」メッセージ表示
  - _Requirements: 2.3, 8.3, 8.4, 8.5, 8.6_

- [ ] 4. テンプレートの実装
- [ ] 4.1 個別レビュー詳細テンプレートの作成
  - base.html を継承したテンプレート構造
  - パンくずリスト（ホーム > 企業一覧 > 企業名 > レビュー）
  - レビューヘッダー（企業名リンク、投稿者、投稿日時、在籍状況、勤務期間）
  - 評価サマリー（個別平均スコア、回答項目数）
  - 6つの評価項目のカード形式表示（星評価 + コメント）
  - 未回答項目の「未回答」表示
  - プレビューモード時のマスキング表示
  - アクションボタン（企業ページに戻る、他のレビューを見る）
  - _Requirements: 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 4.3, 6.1, 6.2_

- [ ] 4.2 質問別レビュー一覧テンプレートの作成
  - base.html を継承したテンプレート構造
  - パンくずリスト（ホーム > 企業一覧 > 企業名 > 評価項目名）
  - ページヘッダー（企業名、評価項目名、平均スコア、レビュー総数）
  - レビューカードのリスト表示（投稿者、投稿日時、在籍状況、評価、コメント、詳細リンク）
  - ページネーションUI（前/次ボタン、ページ番号リンク）
  - レビュー0件時のメッセージ表示
  - プレビューモード時のマスキング表示
  - _Requirements: 2.5, 2.6, 2.7, 2.10, 4.3, 6.3, 6.4, 6.6_

- [ ] 4.3 レスポンシブデザインの実装
  - モバイル（幅768px以下）とデスクトップ（幅768px以上）の切り替え
  - モバイルでの縦積みレイアウト
  - デスクトップでの2列グリッドレイアウト（オプション）
  - タッチデバイスでの操作性向上
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [ ] 5. ルーティング設定とアプリケーション統合
- [ ] 5.1 URLルーティングの設定
  - `/companies/{company_id}/reviews/{review_id}` のルート追加
  - `/companies/{company_id}/reviews/by-category/{category_name}` のルート追加
  - ハンドラーとデータベースサービス、匿名化サービスの依存性注入
  - 既存ルートとの整合性確認
  - _Requirements: 1.1, 2.1_

- [ ] 5.2 アプリケーションへの統合
  - app.py へのハンドラー登録
  - 必要なサービスのインスタンス生成と初期化
  - 設定ファイルでの環境変数管理（匿名化ソルトなど）
  - _Requirements: All requirements_

- [ ] 6. データベースインデックスの作成
- [ ] 6.1 クエリパフォーマンス最適化のためのインデックス
  - reviews コレクションに company_id + is_active + created_at の複合インデックス
  - reviews コレクションに各評価項目（ratings.recommendation など）の複合インデックス
  - インデックス作成スクリプトの実装
  - 既存インデックスとの重複確認
  - _Requirements: 7.3, 7.5_

- [ ] 7. 単体テストの実装
- [ ] 7.1 匿名化サービスのテスト
  - 同じuser_idで一貫した匿名化表示が生成されることの確認
  - 異なるuser_idで異なる匿名化表示が生成されることの確認
  - 匿名化表示が「ユーザー[A-Z]」形式であることの確認
  - ソルト変更時に異なる匿名化表示が生成されることの確認
  - レビューオブジェクト匿名化機能のテスト
  - _Requirements: 3.2, 3.3, 3.4_

- [ ] 7.2 ハンドラーのヘルパーメソッドテスト
  - カテゴリ名バリデーション機能のテスト
  - ページネーション計算ロジックのテスト
  - アクセスレベル判定ロジックのテスト
  - _Requirements: 2.4, 2.10, 4.2, 4.3, 4.4_

- [ ] 8. 統合テストの実装
- [ ] 8.1 個別レビュー詳細ページの統合テスト
  - フルアクセスユーザーが全詳細を閲覧できることの確認
  - プレビューユーザーがコメントマスクされた表示を見ることの確認
  - 未認証ユーザーがログインページにリダイレクトされることの確認
  - 存在しないreview_idで404エラーが返されることの確認
  - is_active=False のレビューで404エラーが返されることの確認
  - _Requirements: 1.1, 1.2, 4.1, 4.2, 4.3, 4.4, 8.1_

- [ ] 8.2 質問別レビュー一覧ページの統合テスト
  - 有効なカテゴリ名でレビュー一覧が表示されることの確認
  - 無効なカテゴリ名で400エラーが返されることの確認
  - ページネーションが正しく動作することの確認（page=2アクセス）
  - レビュー20件以下でページネーションが非表示になることの確認
  - レビュー0件で「レビューがありません」メッセージが表示されることの確認
  - _Requirements: 2.1, 2.3, 2.9, 2.10, 8.3, 8.5_

- [ ] 8.3 アクセス制御の統合テスト
  - 各アクセスレベル（DENIED, PREVIEW, FULL, CRAWLER）での挙動確認
  - プレビューモード時のコメントマスキング確認
  - CTAボタンの表示/非表示確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 8.4 パフォーマンステスト
  - 個別レビュー詳細ページが200ms以内にレンダリングされることの確認
  - 質問別レビュー一覧ページが300ms以内にレンダリングされることの確認
  - データベースクエリのインデックス使用状況の確認
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 9. エンドツーエンドテストの実装
- [ ] 9.1 フルアクセスユーザーのレビュー閲覧フロー
  - ユーザーログイン
  - 企業一覧からレビュー投稿済み企業を選択
  - レビュー一覧から「詳細を見る」をクリック
  - 個別レビュー詳細ページで全項目のコメントが表示されることを確認
  - 「企業ページに戻る」リンクで企業詳細ページに戻ることを確認
  - _Requirements: 1.3, 1.5, 1.8, 6.1, 6.5_

- [ ] 9.2 プレビューユーザーの質問別レビュー閲覧フロー
  - ユーザーログイン（レビュー未投稿）
  - 企業詳細ページで「受入制度のレビューを見る」リンクをクリック
  - 質問別レビュー一覧ページが表示されることを確認
  - コメントがマスクされていることを確認
  - 「レビューを投稿して全てを見る」CTAボタンが表示されることを確認
  - _Requirements: 2.5, 2.6, 4.3, 4.6, 6.3_

- [ ] 9.3 ページネーション操作フロー
  - 20件以上のレビューがある企業の質問別レビュー一覧にアクセス
  - ページネーションが表示されることを確認
  - 「次へ」ボタンをクリックして2ページ目に移動
  - URLに `?page=2` が含まれることを確認
  - 2ページ目のレビュー内容が表示されることを確認
  - _Requirements: 2.9, 2.10, 6.6_

- [ ] 10. ドキュメンテーションとコードレビュー
- [ ] 10.1 コードドキュメントの作成
  - 各ハンドラーのdocstring追加
  - 匿名化サービスのAPI仕様ドキュメント
  - テンプレート変数の仕様ドキュメント
  - _Requirements: 9.1, 9.2, 9.3, 9.4_

- [ ] 10.2 README更新
  - 新機能の概要説明追加
  - URL構造の説明追加
  - 使用例とスクリーンショット追加
  - _Requirements: All requirements_

---

## タスク依存関係

```
1. ユーザー匿名化サービス
   ├─→ 2. 個別レビュー詳細ページ
   └─→ 3. 質問別レビュー一覧ページ

2. 個別レビュー詳細ページ
   └─→ 4.1 個別レビュー詳細テンプレート

3. 質問別レビュー一覧ページ
   └─→ 4.2 質問別レビュー一覧テンプレート

4.1, 4.2, 4.3
   └─→ 5. ルーティング設定

5. ルーティング設定
   └─→ 7. 単体テスト
   └─→ 8. 統合テスト
   └─→ 9. E2Eテスト

6. データベースインデックス（並行実施可能）

10. ドキュメンテーション（最後）
```

---

## 推定工数

| タスクグループ | 推定時間 | 備考 |
|---------------|---------|------|
| 1. 匿名化サービス | 2時間 | 単純なロジック |
| 2. 個別レビュー詳細ページ | 4時間 | エラーハンドリング含む |
| 3. 質問別レビュー一覧ページ | 6時間 | ページネーション含む |
| 4. テンプレート | 9時間 | レスポンシブデザイン含む |
| 5. ルーティング設定 | 1時間 | app.py への追加 |
| 6. データベースインデックス | 1時間 | スクリプト作成 |
| 7. 単体テスト | 3時間 | 匿名化とヘルパーメソッド |
| 8. 統合テスト | 6時間 | ハンドラーの全テストケース |
| 9. E2Eテスト | 4時間 | 3つの主要フロー |
| 10. ドキュメンテーション | 2時間 | README更新含む |
| **合計** | **38時間** | 約5人日 |

---

## 実装時の注意事項

### セキュリティ
- ユーザーIDの匿名化は必ずSHA-256ハッシュを使用
- プレビューモード時のコメントマスキングは確実に実施
- 入力パラメータ（company_id, review_id, category_name, page）の厳密なバリデーション
- XSS対策: Jinja2のauto-escape機能を活用

### パフォーマンス
- MongoDBインデックスの適切な使用を確認
- ページネーションによるデータ取得量の制限
- 非同期クエリの適切な使用

### コード品質
- 既存のコーディング規約に準拠
- ログ出力は適切なレベル（info, warning, exception）を使用
- エラーハンドリングは漏れなく実施
- テストカバレッジは80%以上を目標

### 互換性
- 既存のaccess_control_middlewareとの完全な統合
- 既存のReviewモデルとの互換性維持
- Bootstrap 5とのスタイル統一
- モバイルレスポンシブデザインの一貫性

---

**タスクリストバージョン**: 1.0
**作成日**: 2025-11-27
**言語**: 日本語
