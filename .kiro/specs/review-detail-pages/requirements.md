# Requirements Document

## Introduction

本仕様書は、企業レビューの詳細表示機能を定義します。この機能により、ユーザーは個別のレビュー投稿の全詳細を閲覧したり、特定の評価項目（質問）に対する複数ユーザーの回答を比較することができるようになります。

2つの主要なビューを提供します：
1. **個別レビュー詳細ページ**: 1企業・1ユーザーのレビュー投稿の完全な詳細情報
2. **質問別レビュー一覧ページ**: 1企業の特定評価項目に対する全ユーザーの回答比較

これにより、転職検討者や投資家が企業文化・制度・待遇についてより深い洞察を得ることができ、意思決定の質が向上します。

## Requirements

### Requirement 1: 個別レビュー詳細ページの表示

**Objective:** ユーザーとして、特定のレビュー投稿の全詳細情報を閲覧できるようにすることで、企業に関する深い洞察を得る

#### Acceptance Criteria

1. WHEN ユーザーがURL `/companies/{company_id}/reviews/{review_id}` にアクセスした THEN レビュー詳細ページ は当該レビューの全詳細情報を表示しなければならない

2. IF レビューが存在しない THEN レビュー詳細ページ は404エラーページを表示しなければならない

3. WHEN レビュー詳細ページが表示された THEN レビュー詳細ページ は以下の情報を含まなければならない：
   - 企業名（リンク付き）
   - 投稿者の匿名化表示（例：「ユーザーA」「元従業員」など）
   - 投稿日時
   - 在籍状況（現職/元職）
   - 勤務期間（開始年〜終了年）
   - 6つの評価項目それぞれの星評価（1-5または未回答）
   - 各評価項目のコメント（テキスト）
   - 個別平均評価スコア

4. WHEN レビュー詳細ページが6つの評価項目を表示する THEN レビュー詳細ページ は以下の項目を日本語名で表示しなければならない：
   - 推薦度 (recommendation)
   - 受入制度 (foreign_support)
   - 会社風土 (company_culture)
   - 関係性 (employee_relations)
   - 評価制度 (evaluation_system)
   - 昇進待遇 (promotion_treatment)

5. WHEN 各評価項目が表示される THEN レビュー詳細ページ は星評価（1-5）とコメントを並べて表示しなければならない

6. IF 評価項目に回答がない（Noneまたは空） THEN レビュー詳細ページ は「未回答」と表示しなければならない

7. WHEN レビューが多言語対応されている THEN レビュー詳細ページ は元の言語とすべての翻訳版を表示しなければならない

8. WHEN ユーザーが企業名リンクをクリックした THEN レビュー詳細ページ は企業詳細ページ (`/companies/{company_id}`) にリダイレクトしなければならない

### Requirement 2: 質問別レビュー一覧ページの表示

**Objective:** ユーザーとして、特定の評価項目（質問）に対する複数ユーザーの回答を比較できるようにすることで、企業の特定側面について多角的な視点を得る

#### Acceptance Criteria

1. WHEN ユーザーがURL `/companies/{company_id}/reviews/by-category/{category_name}` にアクセスした THEN 質問別レビュー一覧ページ は当該企業の当該評価項目に対するすべてのレビューをリスト表示しなければならない

2. IF 企業が存在しない THEN 質問別レビュー一覧ページ は404エラーページを表示しなければならない

3. IF 評価項目名（category_name）が無効 THEN 質問別レビュー一覧ページ は400エラーページを表示しなければならない

4. WHEN 有効な評価項目名は以下のいずれかである：
   - recommendation（推薦度）
   - foreign_support（受入制度）
   - company_culture（会社風土）
   - employee_relations（関係性）
   - evaluation_system（評価制度）
   - promotion_treatment（昇進待遇）

5. WHEN 質問別レビュー一覧ページが表示された THEN 質問別レビュー一覧ページ は以下の情報をページヘッダーに表示しなければならない：
   - 企業名（リンク付き）
   - 評価項目名（日本語表示）
   - 当該項目の平均評価スコア
   - レビュー総数

6. WHEN 質問別レビュー一覧ページが各レビューを表示する THEN 質問別レビュー一覧ページ は以下の情報をカード形式で表示しなければならない：
   - 投稿者の匿名化表示
   - 投稿日時
   - 在籍状況
   - 勤務期間
   - 当該項目の星評価（1-5または未回答）
   - 当該項目のコメント（テキスト）
   - 「詳細を見る」リンク（個別レビュー詳細ページへ）

7. IF 当該評価項目に回答していないレビューが存在する THEN 質問別レビュー一覧ページ はそのレビューを「未回答」と表示しなければならない

8. WHEN レビューが多数存在する THEN 質問別レビュー一覧ページ はデフォルトで投稿日時の降順（新しい順）でソートしなければならない

9. WHEN 質問別レビュー一覧ページにレビューが20件以上存在する THEN 質問別レビュー一覧ページ はページネーション機能を提供しなければならない

10. WHEN ページネーションが表示される THEN 質問別レビュー一覧ページ は1ページあたり20件のレビューを表示しなければならない

### Requirement 3: ユーザー匿名化とプライバシー保護

**Objective:** レビュー投稿者として、個人情報が保護され匿名性が確保されることで、安心してレビューを投稿できる

#### Acceptance Criteria

1. WHEN レビュー詳細ページまたは質問別レビュー一覧ページが投稿者情報を表示する THEN システム は実名やメールアドレスを表示してはならない

2. WHEN システムが投稿者を表示する THEN システム は以下のいずれかの匿名化表示を使用しなければならない：
   - 「ユーザー[ランダムID]」（例：「ユーザーA」「ユーザーB」）
   - 「元従業員」または「現従業員」

3. IF 同一ユーザーが同一企業に複数レビューを投稿している THEN システム は一貫した匿名IDを使用しなければならない

4. WHEN システムがランダムIDを生成する THEN システム はuser_idから予測不可能なハッシュ化された値を使用しなければならない

### Requirement 4: アクセス制御の統合

**Objective:** システム管理者として、既存のアクセス制御ポリシーを新機能にも適用することで、一貫したセキュリティを維持する

#### Acceptance Criteria

1. WHEN 未認証ユーザーがレビュー詳細ページまたは質問別レビュー一覧ページにアクセスした THEN システム はアクセス拒否メッセージを表示しなければならない

2. WHEN 認証済みだがレビュー未投稿のユーザーがアクセスした THEN システム はプレビューモードで限定的な情報を表示しなければならない

3. IF プレビューモードが有効 THEN システム は評価スコアと投稿日時のみを表示し、コメント内容をマスキングしなければならない

4. WHEN レビュー投稿済みユーザーがアクセスした THEN システム は全情報を表示しなければならない（完全アクセス）

5. WHEN 検索エンジンbot（クローラー）がアクセスした THEN システム はSEO最適化のための最小限の情報を表示しなければならない

6. IF アクセスレベルが「拒否」または「プレビュー」 THEN システム はレビュー投稿を促すCTA（Call To Action）を表示しなければならない

### Requirement 5: レスポンシブデザイン対応

**Objective:** ユーザーとして、どのデバイスからでも快適にレビュー詳細を閲覧できるようにする

#### Acceptance Criteria

1. WHEN レビュー詳細ページまたは質問別レビュー一覧ページがモバイルデバイス（幅768px以下）で表示される THEN システム はモバイル最適化レイアウトを使用しなければならない

2. WHEN レビュー詳細ページまたは質問別レビュー一覧ページがタブレットまたはデスクトップ（幅768px以上）で表示される THEN システム はデスクトップ最適化レイアウトを使用しなければならない

3. WHEN モバイルレイアウトが表示される THEN システム は評価項目を縦方向に積み重ねて表示しなければならない

4. WHEN デスクトップレイアウトが表示される THEN システム は評価項目を2列グリッドで表示してもよい

5. WHEN 質問別レビュー一覧ページがモバイルで表示される THEN システム はレビューカードを1列で積み重ねて表示しなければならない

6. WHEN 質問別レビュー一覧ページがデスクトップで表示される THEN システム はレビューカードを2列グリッドで表示してもよい

### Requirement 6: ナビゲーションとユーザビリティ

**Objective:** ユーザーとして、直感的なナビゲーションによりレビュー情報を効率的に探索できる

#### Acceptance Criteria

1. WHEN レビュー詳細ページが表示された THEN レビュー詳細ページ は企業詳細ページへの「戻る」リンクを提供しなければならない

2. WHEN レビュー詳細ページが各評価項目を表示する THEN レビュー詳細ページ は各項目から質問別レビュー一覧ページへのリンクを提供してもよい

3. WHEN 質問別レビュー一覧ページが表示された THEN 質問別レビュー一覧ページ は企業詳細ページへの「戻る」リンクを提供しなければならない

4. WHEN 質問別レビュー一覧ページが他の評価項目を表示する THEN 質問別レビュー一覧ページ は他の評価項目へのタブまたはリンクを提供してもよい

5. WHEN ユーザーが「詳細を見る」リンクをクリックした THEN システム は新しいタブではなく同一タブで個別レビュー詳細ページを開かなければならない

6. WHEN ページネーションが表示される THEN システム は現在のページ番号、総ページ数、前/次ページリンクを提供しなければならない

### Requirement 7: パフォーマンスとスケーラビリティ

**Objective:** システム管理者として、大量のレビューデータでも高速なページ表示を維持する

#### Acceptance Criteria

1. WHEN レビュー詳細ページが表示される THEN システム は2秒以内にページを完全にレンダリングしなければならない

2. WHEN 質問別レビュー一覧ページが表示される THEN システム は3秒以内に最初の20件のレビューをレンダリングしなければならない

3. WHEN MongoDBからレビューデータを取得する THEN システム は適切なインデックス（company_id, is_active, created_at）を使用しなければならない

4. WHEN 質問別レビュー一覧ページが大量のレビューを持つ企業を表示する THEN システム はページネーション機能により表示件数を制限しなければならない

5. IF レビュー詳細ページで関連データ（企業情報など）を取得する THEN システム は非同期クエリを使用してデータベースアクセスを最適化しなければならない

### Requirement 8: エラーハンドリングとユーザーフィードバック

**Objective:** ユーザーとして、エラーが発生した際に明確なフィードバックを受け取り、次のアクションを理解できる

#### Acceptance Criteria

1. IF 指定されたレビューIDが存在しない THEN システム は404エラーページを表示し「レビューが見つかりませんでした」というメッセージを表示しなければならない

2. IF 指定された企業IDが存在しない THEN システム は404エラーページを表示し「企業が見つかりませんでした」というメッセージを表示しなければならない

3. IF 評価項目名（category_name）が無効 THEN システム は400エラーページを表示し「無効な評価項目です」というメッセージを表示しなければならない

4. IF データベース接続エラーが発生した THEN システム は500エラーページを表示し「サーバーエラーが発生しました。しばらくしてから再度お試しください」というメッセージを表示しなければならない

5. WHEN 質問別レビュー一覧ページで当該評価項目に回答したレビューが0件である THEN システム は「この項目に関するレビューはまだありません」というメッセージを表示しなければならない

6. WHEN エラーページが表示される THEN システム はホームページまたは企業一覧ページへのナビゲーションリンクを提供しなければならない

### Requirement 9: 将来の拡張性

**Objective:** 開発チームとして、将来的な機能拡張に対応できる柔軟な設計を実現する

#### Acceptance Criteria

1. WHEN レビュー詳細ページが設計される THEN システム は将来の「いいね」ボタンや「参考になった」ボタンのためのプレースホルダーを用意してもよい

2. WHEN レビューデータモデルが設計される THEN システム は将来の反応機能（リアクション）のためのフィールドを考慮した拡張可能な構造を持たなければならない

3. WHEN 質問別レビュー一覧ページが設計される THEN システム は将来のソート機能（評価順、投稿日順など）のための拡張ポイントを用意してもよい

4. WHEN APIハンドラーが実装される THEN システム は将来のフィルタリング機能（在籍状況、勤務期間など）のための拡張可能なパラメータ構造を持たなければならない

## 技術的制約

### データソース
- 既存のMongoDBコレクション「reviews」を使用
- 既存のReviewモデル（`src/models/review.py`）のデータ構造に準拠

### 認証・認可
- 既存の`access_control_middleware.py`を使用
- review-listing-page仕様と同じアクセスレベル（Denied, Preview, Full, Crawler）を適用

### フレームワーク
- Tornado 6.5.2を使用したHTTPハンドラー実装
- Jinja2テンプレートエンジンによるサーバーサイドレンダリング
- Bootstrap 5によるレスポンシブデザイン

### URL設計
- `/companies/{company_id}/reviews/{review_id}` - 個別レビュー詳細
- `/companies/{company_id}/reviews/by-category/{category_name}` - 質問別レビュー一覧

### UI表示制約
- 企業詳細ページで「データソース」フィールドは表示しない（データベースには保持）
- データソースはバックエンドでのデータ管理目的のみで使用

### ドキュメンテーション要件
- ページ構成と各ページの表示項目を入れ子構造で記載すること
- 実装後の保守性向上のため、全ページの構造を文書化すること

## ページ構成と表示項目

### 個別レビュー詳細ページ (`/companies/{company_id}/reviews/{review_id}`)

```
個別レビュー詳細ページ
├── ヘッダー部
│   ├── パンくずリスト
│   │   └── ホーム > 企業一覧 > {企業名} > レビュー
│   ├── 企業名（リンク付き）
│   └── 戻るリンク（企業詳細ページへ）
│
├── レビュー基本情報
│   ├── 投稿者の匿名化表示（例：ユーザーA）
│   ├── 投稿日時
│   ├── 在籍状況（現職/元職）
│   └── 勤務期間（開始年〜終了年）
│
├── 評価サマリー
│   ├── 個別平均評価スコア
│   └── 回答項目数
│
├── 評価項目詳細（6項目）
│   ├── 推薦度
│   │   ├── 星評価（1-5または未回答）
│   │   └── コメント（テキスト）
│   ├── 受入制度
│   │   ├── 星評価（1-5または未回答）
│   │   └── コメント（テキスト）
│   ├── 会社風土
│   │   ├── 星評価（1-5または未回答）
│   │   └── コメント（テキスト）
│   ├── 関係性
│   │   ├── 星評価（1-5または未回答）
│   │   └── コメント（テキスト）
│   ├── 評価制度
│   │   ├── 星評価（1-5または未回答）
│   │   └── コメント（テキスト）
│   └── 昇進待遇
│       ├── 星評価（1-5または未回答）
│       └── コメント（テキスト）
│
├── 多言語表示（該当する場合）
│   ├── 元の言語のコメント
│   └── 翻訳版コメント（EN/ZH/JA）
│
└── アクション部
    ├── 企業詳細ページに戻るボタン
    └── CTA（プレビューモードの場合）
        └── レビュー投稿を促すメッセージ
```

### 質問別レビュー一覧ページ (`/companies/{company_id}/reviews/by-category/{category_name}`)

```
質問別レビュー一覧ページ
├── ヘッダー部
│   ├── パンくずリスト
│   │   └── ホーム > 企業一覧 > {企業名} > {評価項目名}
│   ├── 企業名（リンク付き）
│   ├── 評価項目名（日本語表示）
│   ├── 当該項目の平均評価スコア
│   ├── レビュー総数
│   └── 戻るリンク（企業詳細ページへ）
│
├── レビューリスト（カード形式）
│   └── レビューカード（各レビュー）
│       ├── 投稿者の匿名化表示
│       ├── 投稿日時
│       ├── 在籍状況
│       ├── 勤務期間
│       ├── 当該項目の星評価（1-5または未回答）
│       ├── 当該項目のコメント（テキスト、プレビューモードではマスキング）
│       └── 「詳細を見る」リンク（個別レビュー詳細ページへ）
│
├── ページネーション（20件以上の場合）
│   ├── 現在のページ番号
│   ├── 総ページ数
│   ├── 前ページリンク
│   └── 次ページリンク
│
└── 空状態メッセージ（レビュー0件の場合）
    └── 「この項目に関するレビューはまだありません」
```

### 企業詳細ページへの統合要素

```
企業詳細ページ（既存ページへの追加要素）
├── （既存コンテンツ）
│
├── レビューサマリーセクション（既存）
│   └── （既存のレビュー表示）
│
└── 質問別レビュー一覧セクション（新規追加）
    ├── セクションタイトル：「質問別レビュー一覧」
    └── カテゴリボタングリッド（3列×2行、モバイルは1列）
        ├── 推薦度のレビューを見るボタン
        ├── 受入制度のレビューを見るボタン
        ├── 会社風土のレビューを見るボタン
        ├── 関係性のレビューを見るボタン
        ├── 評価制度のレビューを見るボタン
        └── 昇進待遇のレビューを見るボタン
```

### レビュー一覧ページへの統合要素

```
レビュー一覧ページ（既存ページへの変更）
├── （既存コンテンツ）
│
└── 企業カード（各企業）
    ├── （既存の企業情報）
    └── カテゴリバッジ（変更：クリッカブルリンク化）
        ├── 推薦度バッジ → カテゴリ別レビュー一覧へのリンク
        ├── 受入制度バッジ → カテゴリ別レビュー一覧へのリンク
        ├── 会社風土バッジ → カテゴリ別レビュー一覧へのリンク
        ├── 関係性バッジ → カテゴリ別レビュー一覧へのリンク
        ├── 評価制度バッジ → カテゴリ別レビュー一覧へのリンク
        └── 昇進待遇バッジ → カテゴリ別レビュー一覧へのリンク
```
