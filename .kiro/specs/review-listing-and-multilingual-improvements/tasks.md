# 実装タスク

## タスク概要

本ドキュメントは、レビュー一覧とアクセス制御、多言語対応レビュー投稿フロー、雇用期間バリデーションの実装タスクを定義します。

要件と設計に基づき、段階的な実装計画を策定し、各タスクが完了後に統合可能な形で進行します。

## 実装計画

- [x] 1. データモデル拡張とマイグレーション準備
- [x] 1.1 Review モデルの多言語フィールド追加
  - Review モデルに `language` フィールドを追加（"en", "ja", "zh"）
  - `comments_ja`、`comments_zh`、`comments_en` フィールドを追加（オプショナル）
  - 既存のスキーマバリデーションを拡張し、言語コードのホワイトリスト検証を実装
  - MongoDBインデックス `{ language: 1 }` を追加
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 1.2 User モデルにレビュー投稿日時フィールド追加
  - User モデルに `last_review_posted_at` フィールドを追加（datetime型、オプショナル）
  - MongoDBインデックス `{ last_review_posted_at: -1 }` を追加
  - _Requirements: 1.8_

- [x] 1.3 既存データのマイグレーションスクリプト作成
  - 全てのReviewドキュメントに `language: "ja"` をデフォルト設定
  - 全てのUserドキュメントに最新レビュー投稿日時を `last_review_posted_at` に設定
  - マイグレーション実行前後のデータ整合性検証スクリプトを含める
  - _Requirements: 4.1, 1.8_

- [x] 2. アクセス制御層の実装
- [x] 2.1 UserService にレビュー投稿履歴管理機能を追加
  - 最終レビュー投稿日時を取得する機能を実装
  - 最終レビュー投稿日時を更新する機能を実装
  - 1年以内のレビュー投稿履歴をチェックする機能を実装
  - _Requirements: 1.7, 1.8_

- [x] 2.2 AccessControlMiddleware にレビュー一覧アクセス制御を追加
  - ユーザーの認証状態を判定する機能を拡張
  - レビュー投稿履歴に基づくアクセスレベル判定を実装（full/preview/crawler/denied）
  - User-Agent からWebクローラーを検出する機能を実装
  - アクセスレベルに応じたメッセージ生成を実装
  - _Requirements: 1.1, 1.2, 1.3, 1.7_

- [x] 2.3 ReviewListHandler にプレビュー表示機能を追加
  - レビューコメントを最初の1行または128文字で切り詰める機能を実装
  - 残りの部分を伏せ字（"●●●●●"）で置き換える機能を実装
  - アクセス制御結果に基づいてコンテンツを動的に生成する機能を実装
  - _Requirements: 1.1, 1.2_

- [x] 2.4 ReviewListHandler にフィルター機能統合
  - アクセスレベルが"full"の場合のみフィルター機能を有効化
  - 会社別フィルター機能を実装
  - 地域別フィルター機能を実装
  - レビュー評価しきい値による絞り込み機能を実装
  - _Requirements: 1.4, 1.5, 1.6_

- [x] 3. 多言語対応フォームの実装
- [x] 3.1 I18nFormService の作成
  - 3言語（英語・日本語・中国語）のフォーム翻訳辞書を作成
  - Accept-Language ヘッダーからブラウザ言語を検出する機能を実装
  - サポート言語リストを取得する機能を実装
  - フォーム翻訳データをJSON形式で返す機能を実装
  - _Requirements: 2.1, 2.2, 2.5, 2.6, 2.7, 2.8_

- [x] 3.2 レビュー投稿フォームテンプレートの多言語対応
  - 言語選択ドロップダウンをフォーム最上部に追加
  - フォーム翻訳辞書をJavaScriptで利用可能な形式で埋め込み
  - 各フォームフィールドに言語切り替え用のデータ属性を追加
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 3.3 フォーム言語切り替えのJavaScript実装
  - 言語選択ドロップダウンの変更イベントハンドラーを実装
  - 選択された言語に応じてラベルとプレースホルダーを動的に切り替える機能を実装
  - ブラウザ言語設定に基づくデフォルト言語設定機能を実装
  - 言語選択状態をフォームデータに含める機能を実装
  - _Requirements: 2.3, 2.4, 2.5_

- [x] 4. 雇用期間自動入力とバリデーションの実装
- [x] 4.1 雇用状態選択時の自動入力JavaScript実装
  - 「現従業員」選択時に雇用終了年月を「現在」に自動設定する機能を実装
  - 「現従業員」選択時に雇用終了年月フィールドを無効化する機能を実装
  - 「元従業員」選択時に雇用終了年月フィールドを有効化する機能を実装
  - 雇用状態変更時のフィールド状態同期機能を実装
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 4.2 雇用期間バリデーションロジックの実装
  - 元従業員選択時の雇用開始年必須チェックを実装
  - 元従業員選択時の雇用終了年必須チェックを実装
  - 雇用開始年と終了年の論理整合性チェック（開始年 <= 終了年）を実装
  - 現従業員選択時のバリデーションスキップロジックを実装
  - バリデーションエラーメッセージの多言語対応を実装
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.6, 7.7_

- [x] 4.3 バリデーションエラー表示機能の実装
  - フォーム送信時のクライアントサイドバリデーション実行機能を実装
  - バリデーションエラー時の確認画面遷移ブロック機能を実装
  - エラーメッセージを該当フィールド近くに赤色で表示する機能を実装
  - 複数エラー同時表示のサポート機能を実装
  - _Requirements: 7.4, 7.5_

- [x] 5. 翻訳サービスの統合
- [x] 5.1 TranslationService の作成（DeepL API統合）
  - DeepL API接続設定を実装（APIキー、エンドポイント設定）
  - REST API統合を実装（httpxを使用した非同期リクエスト）
  - 元言語に応じて他の2言語に翻訳するロジックを実装
  - DeepL APIのJSON応答をパースする機能を実装
  - 5秒のタイムアウト設定を実装（30秒から短縮）
  - _Requirements: 3.4, 4.3_

- [x] 5.2 DeepL API エラーハンドリングとGraceful Degradation
  - API接続失敗時のエラーハンドリングを実装
  - タイムアウト時のGraceful Degradation（翻訳なしで投稿継続）を実装
  - JSON解析失敗時のエラーハンドリングを実装
  - エラーログ記録とメトリクス更新機能を実装
  - 翻訳失敗時もレビュー投稿が成功する処理フローを実装
  - _Requirements: 3.4, 5.5_

- [x] 5.3 並列翻訳機能の実装
  - 2言語への翻訳を並列実行する機能を実装（asyncio.gather）
  - translate_to_other_languagesメソッドを実装
  - ReviewCreateHandlerの確認画面と投稿モードに並列翻訳を統合
  - 翻訳文字数の測定とログ記録機能を実装
  - ユニットテスト7個を追加（すべてパス）
  - _Requirements: 4.3_

- [x] 6. レビュー投稿確認画面の実装
- [x] 6.1 ReviewCreateHandler に確認画面モードを追加
  - POSTリクエストの `mode` パラメータ（confirm/submit）を処理する機能を実装
  - 確認モード時にフォームデータをバリデーションする機能を実装
  - 確認モード時に翻訳サービスを呼び出す機能を実装
  - 確認画面テンプレートにデータを渡す機能を実装
  - _Requirements: 3.1, 3.4_

- [x] 6.2 確認画面テンプレートの作成
  - 全ての評価項目（7段階評価）を表示する機能を実装
  - 選択された言語で入力されたコメントを原文表示する機能を実装
  - 他の2言語の翻訳コメントを表示する機能を実装（3言語すべて対応）
  - 「投稿」ボタンと「戻る」ボタンを実装
  - _Requirements: 3.2, 3.3, 3.4, 3.5, 3.6_

- [x] 6.3 確認画面のナビゲーション機能実装
  - 「戻る」ボタンクリック時に入力内容を保持してフォーム画面に戻る機能を実装
  - 「投稿」ボタンクリック時にレビュー保存処理を実行する機能を実装
  - フォームデータの一時保存機能（隠しフィールド）を実装
  - _Requirements: 3.7, 3.8_

- [x] 7. レビュー保存処理の多言語対応
- [x] 7.1 ReviewSubmissionService の多言語データ保存機能拡張
  - レビュー投稿時に言語フィールドを含めて保存する機能を実装
  - 元言語のコメントを `comments` フィールドに保存する機能を実装
  - 翻訳された他の2言語のコメントを専用フィールドに保存する機能を実装
  - 言語フィールドの必須検証を実装
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 7.2 レビュー投稿時の User.last_review_posted_at 更新
  - レビュー保存成功時に UserService を呼び出して最終投稿日時を更新する機能を実装
  - 更新処理の例外ハンドリングを実装
  - _Requirements: 1.8_

- [x] 8. レビュー投稿完了フィードバックの実装
- [x] 8.1 投稿成功メッセージの表示機能実装
  - レビュー保存成功時に企業詳細ページにリダイレクトする機能を実装
  - フラッシュメッセージ「Review投稿しました。ありがとうございました。」を表示する機能を実装
  - 成功メッセージを緑色で目立つように表示する機能を実装
  - 5秒後に自動的にメッセージをフェードアウトする機能を実装（JavaScript）
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 8.2 投稿失敗時のエラーハンドリング実装
  - レビュー保存失敗時にエラーメッセージを表示する機能を実装
  - エラー発生時にユーザーを確認画面に留める機能を実装
  - エラーの種類に応じた適切なメッセージ表示機能を実装
  - _Requirements: 5.5_

- [x] 9. テンプレートとUIの統合
- [x] 9.1 レビュー一覧テンプレートのアクセス制御対応
  - アクセスレベルに応じたコンテンツ表示分岐を実装
  - プレビュー表示時の伏せ字レンダリングを実装
  - Webクローラー向けの最小限テキスト表示を実装
  - アクセス拒否時のメッセージ表示を実装
  - _Requirements: 1.1, 1.2, 1.7_

- [x] 9.2 フィルター機能UIの実装
  - 会社別フィルタードロップダウンの実装
  - 地域別フィルタードロップダウンの実装
  - レビュー評価しきい値スライダーの実装
  - フィルター適用時の一覧更新機能を実装
  - _Requirements: 1.4, 1.5, 1.6_

- [x] 10. ユニットテスト実装
- [x] 10.1 AccessControlMiddleware テスト
  - 未認証ユーザーのアクセスレベル判定テストを実装（11テスト合格）
  - Webクローラー検出テスト（Googlebot, Bingbot, 他）を実装
  - 1年以内のレビュー投稿者のアクセスレベル判定テストを実装
  - 1年以上前の投稿者のアクセスレベル判定テストを実装
  - レビュー履歴なしユーザーのアクセスレベル判定テストを実装
  - _Requirements: 1.1, 1.2, 1.3, 1.7_

- [x] 10.2 ReviewListHandler プレビュー機能テスト
  - 128文字以下のコメント表示テストを実装（7テスト合格）
  - 128文字超のコメント切り詰めテストを実装
  - 複数行コメントの最初の1行表示テストを実装
  - 伏せ字生成テストを実装
  - has_more フラグテストを実装
  - _Requirements: 1.1_

- [x] 10.3 I18nFormService テスト
  - 3言語翻訳辞書取得テストを実装（9テスト合格）
  - ブラウザ言語検出テスト（ja, en, zh）を実装
  - 未対応言語のフォールバックテストを実装
  - サポート言語リスト取得テストを実装
  - 翻訳完全性テスト（year_suffix の空文字許容を含む）を実装
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 10.4 TranslationService テスト
  - 日本語から英語+中国語への翻訳テストを実装
  - 中国語から英語+日本語への翻訳テストを実装
  - 英語から日本語+中国語への翻訳テストを実装
  - DeepL APIエラー時のハンドリングテストを実装
  - タイムアウト時のGraceful Degradationテストを実装
  - JSON解析失敗時のエラーハンドリングテストを実装（新規追加）
  - 並列翻訳機能テストを実装（Task 5で実装済み）
  - 5000文字制限のハンドリングテストを実装（新規追加、境界値テストを含む）
  - _Requirements: 3.4, 4.3_

- [x] 10.5 雇用期間バリデーションテスト
  - 現従業員の有効性テストを実装（11テスト合格）
  - 元従業員の有効な雇用期間テストを実装
  - 開始年 > 終了年のバリデーションエラーテストを実装
  - 元従業員で終了年なしのエラーテストを実装
  - 追加テスト: 未来の年、1970年以前の年、両方未入力のケースも実装
  - _Requirements: 7.1, 7.2, 7.3, 7.6, 7.7_

- [x] 11. 統合テスト実装（10テスト合格）
- [x] 11.1 レビュー投稿フロー統合テスト（日本語）
  - 日本語でのレビュー投稿と英語+中国語翻訳保存を検証するテストを実装（3テスト）
  - User.last_review_posted_at 更新ロジックを検証するテストを実装
  - MongoDBデータ構造の正しさを検証するテストを実装
  - _Requirements: 2.6, 3.4, 4.1, 4.2, 4.3, 1.8_

- [x] 11.2 レビュー投稿フロー統合テスト（中国語）
  - 中国語でのレビュー投稿と英語+日本語翻訳保存を検証するテストを実装（1テスト）
  - _Requirements: 2.8, 3.4, 4.1, 4.2, 4.3_

- [x] 11.3 レビュー投稿フロー統合テスト（英語）
  - 英語でのレビュー投稿と日本語+中国語翻訳保存を検証するテストを実装（1テスト）
  - _Requirements: 2.7, 3.4, 4.1, 4.2, 4.3_

- [x] 11.4 翻訳失敗時の統合テスト
  - DeepL API失敗時もレビュー投稿が成功することを検証するテストを実装（2テスト）
  - 翻訳フィールドがNullでもレビュー投稿が成功することを検証（Graceful Degradation）
  - 一部の翻訳が失敗した場合のハンドリングを検証
  - _Requirements: 3.4, 4.3, 5.5_

- [x] 11.5 アクセス制御統合テスト
  - レビュー投稿直後の一覧アクセス可能性を検証するテストを実装（3テスト）
  - 1年後のアクセス権限失効を検証するテストを実装
  - フィルター機能のアクセス制御を検証するテストを実装
  - _Requirements: 1.3, 1.8, 1.4, 1.5, 1.6_

- [ ] 12. E2E/UIテスト実装
- [ ] 12.1 レビュー投稿ユーザージャーニーテスト（日本語）
  - フォーム表示から入力、確認、投稿、成功メッセージまでの完全フローを検証するテストを実装
  - _Requirements: 全要件_

- [ ] 12.2 フォーム言語切り替えテスト
  - 英語→日本語→中国語の言語切り替え動作を検証するテストを実装
  - ラベルとプレースホルダーの正しい切り替えを検証するテストを実装
  - _Requirements: 2.3, 2.6, 2.7, 2.8_

- [ ] 12.3 雇用状態自動入力UIテスト
  - 現従業員選択時の終了年自動設定とフィールド無効化を検証するテストを実装
  - 元従業員選択時のフィールド有効化を検証するテストを実装
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 12.4 バリデーションエラー表示テスト
  - バリデーションエラーメッセージの表示位置と色を検証するテストを実装
  - 複数エラーの同時表示を検証するテストを実装
  - _Requirements: 7.5_

- [ ] 12.5 レビュー一覧アクセス制御UIテスト
  - 未認証ユーザーのプレビュー表示（伏せ字）を検証するテストを実装
  - 認証済みレビュー投稿者の全文表示を検証するテストを実装
  - 認証済み非投稿者の制限メッセージ表示を検証するテストを実装
  - _Requirements: 1.1, 1.3, 1.7_

- [ ] 13. パフォーマンステスト実装
- [ ] 13.1 DeepL API負荷テスト
  - 同時10件のレビュー投稿時の処理時間を測定するテストを実装
  - APIレスポンスタイム（p50, p95, p99）を測定するテストを実装
  - 翻訳文字数使用量とコスト試算を測定するテストを実装
  - 並列翻訳のパフォーマンス効果を測定するテストを実装
  - _Requirements: パフォーマンス目標_

- [ ] 13.2 レビュー一覧パフォーマンステスト
  - フィルター適用時のレスポンスタイム（< 500ms目標）を測定するテストを実装
  - 大量レビュー（1000件以上）のページネーション速度を測定するテストを実装
  - _Requirements: パフォーマンス目標_

- [x] 14. ドキュメントとマイグレーション
- [x] 14.1 APIドキュメント更新
  - ReviewCreateHandler の新規エンドポイント（確認モード、投稿モード）をドキュメント化
  - ReviewListHandler のアクセス制御とフィルターパラメータをドキュメント化
  - エラーレスポンス、セキュリティ、パフォーマンス情報を追加
  - ファイル: `docs/API_DOCUMENTATION.md`
  - _Requirements: 全要件_

- [x] 14.2 環境変数設定ガイド作成
  - DEEPL_API_KEY の設定手順をドキュメント化（Free版/Pro版の違いを含む）
  - DeepL API Free版/Pro版の選択ガイドをドキュメント化
  - Feature Flag の設定方法をドキュメント化
  - セキュリティベストプラクティスとトラブルシューティングを追加
  - ファイル: `docs/ENVIRONMENT_SETUP.md`
  - _Requirements: 翻訳サービス統合_

- [x] 14.3 マイグレーション実行ガイド作成
  - マイグレーションスクリプトの実行手順をドキュメント化（ドライラン含む）
  - 詳細なロールバック手順をドキュメント化（バックアップからの復元、手動削除）
  - バリデーションチェックリストをドキュメント化（マイグレーション前後の確認項目）
  - トラブルシューティングとパフォーマンス情報を追加
  - ファイル: `docs/MIGRATION_GUIDE.md`
  - _Requirements: データモデル拡張_

## 実装順序の注記

上記タスクは依存関係を考慮して設計されています。推奨実装順序：

1. **Phase 1: 基盤整備** - タスク1（データモデル拡張）
2. **Phase 2: アクセス制御** - タスク2（アクセス制御層）、タスク9.1（一覧テンプレート）
3. **Phase 3: 多言語フォーム** - タスク3（多言語フォーム）、タスク4（雇用期間）
4. **Phase 4: 翻訳統合** - タスク5（翻訳サービス）、タスク6（確認画面）
5. **Phase 5: 保存と完了** - タスク7（保存処理）、タスク8（フィードバック）
6. **Phase 6: テストとドキュメント** - タスク10-14

各タスクは完了後に次のタスクに進むことができるように設計されています。
