# Requirements Document

## 導入

認証アクセス制御機能強化は、既存のOAuth認証システムを拡張し、メール認証の6桁コードログイン、.envベースの柔軟なアクセス制御、ユーザーフレンドリーなログインUI、そしてレビュー投稿の利便性向上を実現します。これにより、セキュアかつ使いやすい認証体験と、設定による柔軟なアクセス管理を提供します。

## 要件

### 要件1: メール認証6桁コードログイン機能
**目的:** メール認証ユーザーとして、ログイン時にメールアドレスに送信される6桁コードで認証したい。これにより、パスワード不要で安全なログインを実現できる。

#### 受入基準
1. WHEN メール認証ユーザーがログインを開始 THEN 認証システム SHALL メールアドレス入力フォームを表示する
2. WHEN ユーザーが登録済みメールアドレスを入力 THEN 認証システム SHALL 6桁数字の認証コードを生成してメール送信する
3. WHEN ユーザーが正しい6桁コードを入力 THEN 認証システム SHALL セッションを有効化してユーザーをログイン状態にする
4. WHEN ユーザーが間違った6桁コードを入力 THEN 認証システム SHALL エラーメッセージを表示して再入力を促す
5. WHEN 6桁コードの有効期限(10分)が経過 THEN 認証システム SHALL コードを無効化して新規コード再送機能を提供する
6. WHERE 6桁コードを生成する際 THE 認証システム SHALL cryptographically secureな乱数生成を使用する

### 要件2: SMTP設定テスト機能
**目的:** システム管理者として、.envファイルで設定したSMTP設定が正しく動作することを確認したい。これにより、メール送信機能の正常性を検証できる。

#### 受入基準
1. WHEN システム起動時 THEN 認証システム SHALL .envファイルからSMTP設定(ホスト、ポート、ユーザー名、パスワード)を読み込む
2. WHEN テストメール送信が実行 THEN 認証システム SHALL 設定されたSMTPサーバー経由でテストメールを送信する
3. IF SMTP接続が失敗 THEN 認証システム SHALL 詳細なエラーメッセージをログに記録する
4. IF メール送信が成功 THEN 認証システム SHALL 送信成功をログに記録する
5. WHERE SMTP設定が不完全な場合 THE 認証システム SHALL システム起動時に警告メッセージを表示する

### 要件3: 設定ベースアクセス制御機能
**目的:** システム管理者として、.envファイルでURLパターンと必要なユーザー権限を設定できるようにしたい。これにより、コード変更なしで柔軟にアクセス制御を管理できる。

#### 受入基準

##### 設定読み込みと管理
1. WHEN システム起動時 THEN アクセス制御システム SHALL .envファイルからアクセス制御ルールを読み込む
2. WHERE .envファイルに設定を記載する際 THE アクセス制御システム SHALL "URLパターン,必要権限1,必要権限2,..." の形式をサポートする
3. WHEN 複数のアクセス制御ルールが設定 THEN アクセス制御システム SHALL 各ルールを個別にパースして保持する
4. IF .envファイルの設定形式が不正 THEN アクセス制御システム SHALL エラーメッセージを表示してデフォルトルールを適用する

##### URLパターンマッチングとアクセス判定
5. WHEN ユーザーがURLにアクセス THEN アクセス制御システム SHALL 設定されたURLパターンとの照合を実行する
6. WHEN URLが "/companies/([^/]+)/reviews/new" パターンにマッチ THEN アクセス制御システム SHALL ログイン認証を要求する
7. WHEN URLが "/reviews/([^/]+)/edit" パターンにマッチ THEN アクセス制御システム SHALL ログイン認証を要求する
8. IF ユーザーが未認証 AND アクセス制御が必要なURL THEN アクセス制御システム SHALL ログイン/登録Mini Panelを表示する
9. IF ユーザーが認証済み AND 必要な権限を保持 THEN アクセス制御システム SHALL リクエストされたページへのアクセスを許可する
10. IF ユーザーが認証済み AND 必要な権限を保持しない THEN アクセス制御システム SHALL 403権限不足エラーを表示する

##### 権限チェック
11. WHERE 権限チェックを実行する際 THE アクセス制御システム SHALL ユーザーのユーザータイプと設定された必要権限リストを照合する
12. WHEN 複数のパターンがマッチ THEN アクセス制御システム SHALL 最初にマッチしたルールを適用する
13. WHERE URLが設定パターンを含まない場合 THE アクセス制御システム SHALL 認証不要でアクセスを許可する

### 要件4: ログイン/登録Mini Panel UI機能
**目的:** ユーザーとして、認証が必要なページにアクセス時に右下に表示されるMini Panelから簡単にログイン/登録したい。これにより、スムーズな認証体験を実現できる。

**参考デザイン:** Screenshot at Oct 05.png のような右下配置パネル

#### 受入基準
1. WHEN 未認証ユーザーが認証必要URLにアクセス THEN UI システム SHALL 画面右下にログイン/登録Mini Panelを表示する
2. WHERE Mini Panelのタイトル THE UI システム SHALL "Sign in to DXEEWorld" または類似のタイトルを表示する
3. WHERE Mini Panel内の認証オプション THE UI システム SHALL 以下を順に表示する:
   - "Google でログイン" ボタン (Googleアイコン付き、白背景)
   - "Facebook でログイン" ボタン (Facebookアイコン付き、ダークボタン)
   - Email入力フィールド
   - Password入力フィールド (メール認証の場合は不要、6桁コード入力用)
   - "Sign in with Email" ボタン
   - "Forgot Password?" リンク (必要に応じて)
   - "Don't have an account? Register" リンク
4. WHEN ユーザーがMini Panel内の認証オプションを選択 THEN UI システム SHALL 対応する認証フローを開始する
5. IF ユーザーが既にログイン済み THEN UI システム SHALL Mini Panelを表示しない
6. WHEN ユーザーがMini Panelを閉じる(X ボタンまたは外側クリック) THEN UI システム SHALL Panelを非表示にして元のページを表示する
7. WHERE Mini Panelのデザインスタイル THE UI システム SHALL 以下を満たす:
   - 画面右下に固定配置 (fixed position)
   - 角丸のカードデザイン
   - ダークモード対応の背景色
   - 適度なpadding とshadow効果
   - モバイルでは画面中央に表示
8. WHILE 認証処理中 THE UI システム SHALL ローディングインジケーターを表示する

### 要件5: レビュー投稿フォーム表示制御機能
**目的:** システム管理者として、未認証ユーザーにはレビュー投稿フォームを表示せず、ログインを促したい。これにより、認証されたユーザーのみがレビューを投稿できるようにする。

#### 受入基準
1. WHEN 未認証ユーザーがレビュー投稿URL(/companies/{id}/reviews/new)にアクセス THEN レビューシステム SHALL レビューフォームを非表示にする
2. WHEN 未認証ユーザーがレビュー投稿URLにアクセス THEN レビューシステム SHALL ログイン/登録Mini Panelを右下に表示する
3. IF ユーザーがMini Panel経由でログイン成功 THEN レビューシステム SHALL レビュー投稿フォームを表示する
4. WHEN 認証済みユーザーがレビュー投稿URLにアクセス THEN レビューシステム SHALL 直接レビュー投稿フォームを表示する
5. WHERE レビュー編集URL(/reviews/{id}/edit)の場合 THE レビューシステム SHALL 同様の認証チェックを実行する

### 要件6: 会社詳細ページレビュー投稿リンク機能
**目的:** ユーザーとして、会社詳細ページから簡単にレビューを投稿したい。これにより、1つの会社に対して複数のレビューを投稿できるようにする。

#### 受入基準
1. WHEN 会社詳細ページを表示 AND その会社に1件以上のレビューが存在 THEN UI システム SHALL レビューセクションの上部に「Reviewを投稿する」リンクを表示する
2. WHEN ユーザーが「Reviewを投稿する」リンクをクリック THEN UI システム SHALL レビュー投稿ページ(/companies/{company_id}/reviews/new)に遷移する
3. IF ユーザーが未認証 THEN UI システム SHALL レビュー投稿ページでログイン/登録Mini Panelを表示する
4. IF ユーザーが認証済み THEN UI システム SHALL レビュー投稿フォームを直接表示する
5. WHEN ユーザーが同じ会社に対して2件目以降のレビューを投稿 THEN レビューシステム SHALL 問題なく投稿を受け付ける
6. WHERE 会社にレビューが0件の場合 THE UI システム SHALL 「最初のReviewを投稿する」リンクを表示する
7. WHEN レビュー投稿が完了 THEN UI システム SHALL 会社詳細ページにリダイレクトして新規レビューを表示する

### 要件7: セキュリティとエラーハンドリング
**目的:** システム管理者として、認証とアクセス制御におけるセキュリティリスクを最小化したい。これにより、安全なシステム運用を実現できる。

#### 受入基準
1. WHERE 6桁コードを生成する際 THE 認証システム SHALL `secrets`モジュールを使用して暗号学的に安全な乱数を生成する
2. WHEN 6桁コードをデータベースに保存 THEN 認証システム SHALL ハッシュ化して保存する
3. WHEN ログイン試行が5回連続失敗 THEN 認証システム SHALL 一時的にアカウントをロックする
4. WHEN SMTP接続エラーが発生 THEN 認証システム SHALL 詳細なエラー情報をログに記録し、ユーザーには一般的なエラーメッセージを表示する
5. WHERE セッション管理 THE 認証システム SHALL セッションIDを暗号化し、適切な有効期限を設定する
6. WHEN アクセス制御ルールのパースエラーが発生 THEN アクセス制御システム SHALL エラーをログに記録し、安全なデフォルト設定(全URLで認証要求)にフォールバックする
7. IF ユーザーが無効なセッションでアクセス THEN 認証システム SHALL セッションをクリアしてログインを要求する
